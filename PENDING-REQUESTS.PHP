<?php
/**
 * ========================================================================
 * PENDING-REQUESTS.PHP - ÎšÎ‘Î¡Î¤Î•Î›Î‘ 3: Î•ÎšÎšÎ¡Î•ÎœÎ•Î™Î£ Î‘Î™Î¤Î—Î£Î•Î™Î£ (MANAGER VIEW)
 * ========================================================================
 * 
 * Î£ÎšÎŸÎ ÎŸÎ£:
 * Î ÏÎ¿Î²Î¿Î»Î® ÎºÎ±Î¹ Î´Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· ÎµÎºÎºÏÎµÎ¼ÏÎ½ Î±Î¹Ï„Î®ÏƒÎµÏ‰Î½ Î¬Î´ÎµÎ¹Î±Ï‚ Î±Ï€ÏŒ Ï€ÏÎ¿ÏŠÏƒÏ„Î±Î¼Î­Î½Î¿Ï…Ï‚/administrators.
 * Î Î±ÏÎ­Ï‡ÎµÎ¹ Î´Ï…Î½Î±Ï„ÏŒÏ„Î·Ï„ÎµÏ‚ Î­Î³ÎºÏÎ¹ÏƒÎ·Ï‚, Î±Ï€ÏŒÏÏÎ¹ÏˆÎ·Ï‚ ÎºÎ±Î¹ bulk operations.
 * 
 * Î”Î™ÎšÎ‘Î™Î©ÎœÎ‘Î¤Î‘ Î Î¡ÎŸÎ£Î’Î‘Î£Î—Î£:
 * - ÎœÏŒÎ½Î¿ Ï‡ÏÎ®ÏƒÏ„ÎµÏ‚ Î¼Îµ Î Î¡ÎŸÎ™Î£Î¤Î‘ÎœÎ•ÎÎŸÎ£ = 1 Î® ADMINISTRATOR = 1
 * - Î ÏÎ¿ÏŠÏƒÏ„Î¬Î¼ÎµÎ½Î¿Î¹ Î²Î»Î­Ï€Î¿Ï…Î½ Î¼ÏŒÎ½Î¿ Î±Î¹Ï„Î®ÏƒÎµÎ¹Ï‚ Ï€Î¿Ï… Ï„Î¿Ï…Ï‚ Î­Ï‡Î¿Ï…Î½ Î±Î½Î±Ï„ÎµÎ¸ÎµÎ¯
 * - Administrators Î²Î»Î­Ï€Î¿Ï…Î½ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ Î±Î¹Ï„Î®ÏƒÎµÎ¹Ï‚
 * 
 * ÎšÎ¥Î¡Î™Î•Î£ Î›Î•Î™Î¤ÎŸÎ¥Î¡Î“Î™Î•Î£:
 * - Î ÏÎ¿Î²Î¿Î»Î® ÎµÎºÎºÏÎµÎ¼ÏÎ½ Î±Î¹Ï„Î®ÏƒÎµÏ‰Î½ Î¼Îµ Ï€Î»Î®ÏÎµÎ¹Ï‚ Î»ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹ÎµÏ‚
 * - ÎˆÎ³ÎºÏÎ¹ÏƒÎ·/Î‘Ï€ÏŒÏÏÎ¹ÏˆÎ· Î¼ÎµÎ¼Î¿Î½Ï‰Î¼Î­Î½Ï‰Î½ Î±Î¹Ï„Î®ÏƒÎµÏ‰Î½
 * - Bulk operations (Ï€Î¿Î»Î»Î±Ï€Î»Î­Ï‚ ÎµÎ³ÎºÏÎ¯ÏƒÎµÎ¹Ï‚/Î±Ï€Î¿ÏÏÎ¯ÏˆÎµÎ¹Ï‚)
 * - Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÏ‡Î¿Î»Î¯Ï‰Î½ Ï€ÏÎ¿ÏŠÏƒÏ„Î±Î¼Î­Î½Î¿Ï…
 * - Email notifications ÏƒÏ„Î¿Ï…Ï‚ Ï…Ï€Î±Î»Î»Î®Î»Î¿Ï…Ï‚
 * - Filtering ÎºÎ±Î¹ searching
 * - Export ÏƒÎµ PDF/Excel
 * - Audit trail logging
 * 
 * DEPENDENCIES:
 * - common.php (authentication, database, email functions)
 * - PHPMailer Î³Î¹Î± email notifications
 * - TCPDF Î³Î¹Î± PDF generation
 * 
 * SECURITY FEATURES:
 * - Role-based access control (RBAC)
 * - SQL injection protection
 * - XSS protection
 * - CSRF protection Î¼Îµ tokens
 * - Input validation ÎºÎ±Î¹ sanitization
 * 
 * AUTHOR: Leave Management System Team
 * DATE: 2025
 * VERSION: 2.0
 * LAST MODIFIED: Current Date
 * ========================================================================
 */

// Î•Î¹ÏƒÎ±Î³Ï‰Î³Î® Î²Î±ÏƒÎ¹ÎºÏÎ½ ÏƒÏ…Î½Î±ÏÏ„Î®ÏƒÎµÏ‰Î½ ÎºÎ±Î¹ security checks
require_once 'common.php';
checkAuth(); // Î’Î±ÏƒÎ¹ÎºÏŒÏ‚ Î­Î»ÎµÎ³Ï‡Î¿Ï‚ authentication

// ========================================================================
// AUTHORIZATION CHECK - Î•Î›Î•Î“Î§ÎŸÎ£ Î”Î™ÎšÎ‘Î™Î©ÎœÎ‘Î¤Î©Î Î Î¡ÎŸÎ£Î’Î‘Î£Î—Î£
// ========================================================================

/**
 * ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î±Î½ Î¿ ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Ï‚ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î­Ï‡ÎµÎ¹ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Ï€ÏÎ¿ÏŠÏƒÏ„Î±Î¼Î­Î½Î¿Ï… Î® administrator
 * 
 * BUSINESS LOGIC:
 * - ADMINISTRATOR = 1: Î’Î»Î­Ï€ÎµÎ¹ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ Î±Î¹Ï„Î®ÏƒÎµÎ¹Ï‚ (superuser)
 * - Î Î¡ÎŸÎ™Î£Î¤Î‘ÎœÎ•ÎÎŸÎ£ = 1: Î’Î»Î­Ï€ÎµÎ¹ Î¼ÏŒÎ½Î¿ Î±Î¹Ï„Î®ÏƒÎµÎ¹Ï‚ Ï€Î¿Ï… Ï„Î¿Ï… Î­Ï‡Î¿Ï…Î½ Î±Î½Î±Ï„ÎµÎ¸ÎµÎ¯
 * - Î†Î»Î»Î¿Î¹ Ï‡ÏÎ®ÏƒÏ„ÎµÏ‚: Redirect ÏƒÏ„Î·Î½ Î±ÏÏ‡Î¹ÎºÎ® Î¼Îµ error message
 */
$user_mitroo = $_SESSION['user_mitroo'];
$user_role_check = $pdo->prepare("SELECT Î Î¡ÎŸÎ™Î£Î¤Î‘ÎœÎ•ÎÎŸÎ£, ADMINISTRATOR, ÎŸÎÎŸÎœÎ‘, Î•Î Î©ÎÎ¥ÎœÎŸ FROM users WHERE ÎœÎ—Î¤Î¡Î©ÎŸ = ?");
$user_role_check->execute([$user_mitroo]);
$user_data = $user_role_check->fetch();

// Security: Block access if user is not manager or admin
if (!$user_data || ($user_data['Î Î¡ÎŸÎ™Î£Î¤Î‘ÎœÎ•ÎÎŸÎ£'] != 1 && $user_data['ADMINISTRATOR'] != 1)) {
    $_SESSION['error'] = "âŒ Î”ÎµÎ½ Î­Ï‡ÎµÏ„Îµ Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î± Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚ ÏƒÎµ Î±Ï…Ï„Î® Ï„Î· ÏƒÎµÎ»Î¯Î´Î±.";
    header("Location: index.php");
    exit;
}

// ÎšÎ±Î¸Î¿ÏÎ¹ÏƒÎ¼ÏŒÏ‚ ÎµÏ€Î¹Ï€Î­Î´Î¿Ï… Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚
$is_admin = ($user_data['ADMINISTRATOR'] == 1);
$is_manager = ($user_data['Î Î¡ÎŸÎ™Î£Î¤Î‘ÎœÎ•ÎÎŸÎ£'] == 1);

// ========================================================================
// Î‘Î¡Î§Î™ÎšÎŸÎ ÎŸÎ™Î—Î£Î— ÎœÎ•Î¤Î‘Î’Î›Î—Î¤Î©Î ÎšÎ‘Î™ Î Î‘Î¡Î‘ÎœÎ•Î¤Î¡Î©Î
// ========================================================================

// Messages Î³Î¹Î± user feedback
$success = '';
$error = '';
$info = '';

// Î¦Î¯Î»Ï„ÏÎ± ÎºÎ±Î¹ pagination parameters
$filter_department = $_GET['department'] ?? 'ALL';      // Î¦Î¯Î»Ï„ÏÎ¿ Ï„Î¼Î®Î¼Î±Ï„Î¿Ï‚
$filter_leave_type = $_GET['leave_type'] ?? 'ALL';      // Î¦Î¯Î»Ï„ÏÎ¿ Ï„ÏÏ€Î¿Ï… Î¬Î´ÎµÎ¹Î±Ï‚  
$filter_priority = $_GET['priority'] ?? 'ALL';          // Î¦Î¯Î»Ï„ÏÎ¿ Ï€ÏÎ¿Ï„ÎµÏÎ±Î¹ÏŒÏ„Î·Ï„Î±Ï‚
$filter_date_from = $_GET['date_from'] ?? '';           // Î¦Î¯Î»Ï„ÏÎ¿ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±Ï‚ Î±Ï€ÏŒ
$filter_date_to = $_GET['date_to'] ?? '';               // Î¦Î¯Î»Ï„ÏÎ¿ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±Ï‚ Î­Ï‰Ï‚
$sort_by = $_GET['sort'] ?? 'submitted_at';             // Î ÎµÎ´Î¯Î¿ Ï„Î±Î¾Î¹Î½ÏŒÎ¼Î·ÏƒÎ·Ï‚
$sort_order = $_GET['order'] ?? 'ASC';                  // ÎšÎ±Ï„ÎµÏÎ¸Ï…Î½ÏƒÎ· Ï„Î±Î¾Î¹Î½ÏŒÎ¼Î·ÏƒÎ·Ï‚
$page = max(1, (int)($_GET['page'] ?? 1));              // Î¤ÏÎ­Ï‡Î¿Ï…ÏƒÎ± ÏƒÎµÎ»Î¯Î´Î±
$per_page = 15;                                         // Î‘Î¹Ï„Î®ÏƒÎµÎ¹Ï‚ Î±Î½Î¬ ÏƒÎµÎ»Î¯Î´Î±

// Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ offset Î³Î¹Î± SQL pagination
$offset = ($page - 1) * $per_page;

// CSRF Protection - Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± token Î³Î¹Î± forms
if (!isset($_SESSION['csrf_token'])) {
    $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
}

// ========================================================================
// Î§Î•Î™Î¡Î™Î£ÎœÎŸÎ£ POST REQUESTS - ACTIONS ÎšÎ‘Î™ FORM SUBMISSIONS
// ========================================================================

if ($_POST) {
    // CSRF Protection validation
    if (!isset($_POST['csrf_token']) || $_POST['csrf_token'] !== $_SESSION['csrf_token']) {
        $error = "âŒ ÎœÎ· Î­Î³ÎºÏ…ÏÎ¿ security token. Î Î±ÏÎ±ÎºÎ±Î»Ï Î´Î¿ÎºÎ¹Î¼Î¬ÏƒÏ„Îµ Î¾Î±Î½Î¬.";
    } else {
        $action = $_POST['action'] ?? '';
        
        switch ($action) {
            
            case 'approve_request':
                /**
                 * ================================================================
                 * Î•Î“ÎšÎ¡Î™Î£Î— ÎœÎ•ÎœÎŸÎÎ©ÎœÎ•ÎÎ—Î£ Î‘Î™Î¤Î—Î£Î—Î£
                 * ================================================================
                 * 
                 * Î”Î™Î‘Î”Î™ÎšÎ‘Î£Î™Î‘:
                 * 1. Validation request ID ÎºÎ±Î¹ ownership
                 * 2. ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Ï…Ï€Î¿Î»Î¿Î¯Ï€Ï‰Î½ Î¬Î´ÎµÎ¹Î±Ï‚
                 * 3. Update request status
                 * 4. Î‘Ï†Î±Î¯ÏÎµÏƒÎ· Î±Ï€ÏŒ user balance
                 * 5. Email notification ÏƒÏ„Î¿Î½ Ï…Ï€Î¬Î»Î»Î·Î»Î¿
                 * 6. Audit trail logging
                 * 7. Success/Error feedback
                 */
                
                $request_id = (int)$_POST['request_id'];
                $manager_comments = trim($_POST['manager_comments'] ?? '');
                
                try {
                    // Begin transaction Î³Î¹Î± data consistency
                    $pdo->beginTransaction();
                    
                    // Î›Î®ÏˆÎ· ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Ï‰Î½ Î±Î¯Ï„Î·ÏƒÎ·Ï‚ Î¼Îµ user info
                    $request_sql = "
                        SELECT r.*, u.ÎŸÎÎŸÎœÎ‘, u.Î•Î Î©ÎÎ¥ÎœÎŸ, u.EMAIL, u.Î¤ÎœÎ—ÎœÎ‘
                        FROM requests r
                        JOIN users u ON r.mitroo = u.ÎœÎ—Î¤Î¡Î©ÎŸ
                        WHERE r.id = ? AND r.status = 'Î•ÎšÎšÎ¡Î•ÎœÎ•Î™'
                    ";
                    
                    // Security: Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· WHERE clause Î±Î½Î¬Î»Î¿Î³Î± Î¼Îµ Ï„Î¿ role
                    if (!$is_admin) {
                        $request_sql .= " AND r.selected_manager_mitroo = ?";
                        $stmt = $pdo->prepare($request_sql);
                        $stmt->execute([$request_id, $user_mitroo]);
                    } else {
                        $stmt = $pdo->prepare($request_sql);
                        $stmt->execute([$request_id]);
                    }
                    
                    $request = $stmt->fetch();
                    
                    if (!$request) {
                        throw new Exception("Î— Î±Î¯Ï„Î·ÏƒÎ· Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Î® Î´ÎµÎ½ Î­Ï‡ÎµÏ„Îµ Î´Î¹ÎºÎ±Î¯Ï‰Î¼Î± Î­Î³ÎºÏÎ¹ÏƒÎ·Ï‚.");
                    }
                    
                    // ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Ï…Ï€Î¿Î»Î¿Î¯Ï€Ï‰Î½ Î¬Î´ÎµÎ¹Î±Ï‚ Ï€ÏÎ¹Î½ Ï„Î·Î½ Î­Î³ÎºÏÎ¹ÏƒÎ·
                    $balance_check = checkLeaveBalance(
                        $pdo, 
                        $request['mitroo'], 
                        $request['typos'], 
                        $request['meres'], 
                        0, // imeres_poreias - TODO: Ï€ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÏ„Î· Î²Î¬ÏƒÎ·
                        $request['wres']
                    );
                    
                    if (!$balance_check['status']) {
                        throw new Exception("ÎŸ Ï…Ï€Î¬Î»Î»Î·Î»Î¿Ï‚ Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ ÎµÏ€Î±ÏÎºÎ­Ï‚ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿: " . $balance_check['message']);
                    }
                    
                    // Update request status ÏƒÎµ Î•Î“ÎšÎ•ÎšÎ¡Î™ÎœÎ•ÎÎ—
                    $update_sql = "
                        UPDATE requests 
                        SET status = 'Î•Î“ÎšÎ•ÎšÎ¡Î™ÎœÎ•ÎÎ—',
                            approved_by = ?,
                            approved_at = NOW(),
                            manager_comments = ?
                        WHERE id = ?
                    ";
                    $update_stmt = $pdo->prepare($update_sql);
                    $update_stmt->execute([$user_mitroo, $manager_comments, $request_id]);
                    
                    // Î‘Ï†Î±Î¯ÏÎµÏƒÎ· Î±Ï€ÏŒ user balance
                    updateUserBalance($pdo, $request['mitroo'], $request['typos'], $request['meres'], $request['wres']);
                    
                    // Commit transaction
                    $pdo->commit();
                    
                    // Email notification ÏƒÏ„Î¿Î½ Ï…Ï€Î¬Î»Î»Î·Î»Î¿
                    $email_sent = sendApprovalEmail($pdo, $request_id, $manager_comments);
                    
                    // Audit trail logging
                    logManagerAction($pdo, $user_mitroo, 'APPROVE_REQUEST', [
                        'request_id' => $request_id,
                        'employee_mitroo' => $request['mitroo'],
                        'leave_type' => $request['typos'],
                        'days' => $request['meres'],
                        'hours' => $request['wres'],
                        'comments' => $manager_comments
                    ]);
                    
                    // Success message
                    $success = "âœ… Î— Î±Î¯Ï„Î·ÏƒÎ· ÎµÎ³ÎºÏÎ¯Î¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!";
                    if ($email_sent) {
                        $success .= " Î£Ï„Î¬Î»Î¸Î·ÎºÎµ email ÎµÎ¹Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚ ÏƒÏ„Î¿Î½ Ï…Ï€Î¬Î»Î»Î·Î»Î¿.";
                    }
                    
                } catch (Exception $e) {
                    // Rollback ÏƒÎµ Ï€ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ· ÏƒÏ†Î¬Î»Î¼Î±Ï„Î¿Ï‚
                    $pdo->rollback();
                    $error = "âŒ Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ Î­Î³ÎºÏÎ¹ÏƒÎ·: " . $e->getMessage();
                    
                    // Error logging
                    error_log("APPROVAL ERROR: " . $e->getMessage() . " - User: $user_mitroo, Request: $request_id");
                }
                break;
                
            case 'reject_request':
                /**
                 * ================================================================
                 * Î‘Î ÎŸÎ¡Î¡Î™Î¨Î— ÎœÎ•ÎœÎŸÎÎ©ÎœÎ•ÎÎ—Î£ Î‘Î™Î¤Î—Î£Î—Î£  
                 * ================================================================
                 * 
                 * Î”Î™Î‘Î”Î™ÎšÎ‘Î£Î™Î‘:
                 * 1. Validation request ID ÎºÎ±Î¹ ownership
                 * 2. ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Ï…Ï€Î¿Ï‡ÏÎµÏ‰Ï„Î¹ÎºÏÎ½ ÏƒÏ‡Î¿Î»Î¯Ï‰Î½ Î±Ï€ÏŒÏÏÎ¹ÏˆÎ·Ï‚
                 * 3. Update request status
                 * 4. Email notification Î¼Îµ Î±Î¹Ï„Î¹Î¿Î»Î¿Î³Î¯Î±
                 * 5. Audit trail logging
                 */
                
                $request_id = (int)$_POST['request_id'];
                $rejection_reason = trim($_POST['rejection_reason'] ?? '');
                
                // Validation: Î¥Ï€Î¿Ï‡ÏÎµÏ‰Ï„Î¹ÎºÎ¬ ÏƒÏ‡ÏŒÎ»Î¹Î± Î³Î¹Î± Î±Ï€ÏŒÏÏÎ¹ÏˆÎ·
                if (empty($rejection_reason)) {
                    $error = "âŒ Î— Î±Î¹Ï„Î¹Î¿Î»Î¿Î³Î¯Î± Î±Ï€ÏŒÏÏÎ¹ÏˆÎ·Ï‚ ÎµÎ¯Î½Î±Î¹ Ï…Ï€Î¿Ï‡ÏÎµÏ‰Ï„Î¹ÎºÎ®.";
                    break;
                }
                
                try {
                    $pdo->beginTransaction();
                    
                    // Î›Î®ÏˆÎ· ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Ï‰Î½ Î±Î¯Ï„Î·ÏƒÎ·Ï‚
                    $request_sql = "
                        SELECT r.*, u.ÎŸÎÎŸÎœÎ‘, u.Î•Î Î©ÎÎ¥ÎœÎŸ, u.EMAIL
                        FROM requests r
                        JOIN users u ON r.mitroo = u.ÎœÎ—Î¤Î¡Î©ÎŸ
                        WHERE r.id = ? AND r.status = 'Î•ÎšÎšÎ¡Î•ÎœÎ•Î™'
                    ";
                    
                    if (!$is_admin) {
                        $request_sql .= " AND r.selected_manager_mitroo = ?";
                        $stmt = $pdo->prepare($request_sql);
                        $stmt->execute([$request_id, $user_mitroo]);
                    } else {
                        $stmt = $pdo->prepare($request_sql);
                        $stmt->execute([$request_id]);
                    }
                    
                    $request = $stmt->fetch();
                    
                    if (!$request) {
                        throw new Exception("Î— Î±Î¯Ï„Î·ÏƒÎ· Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Î® Î´ÎµÎ½ Î­Ï‡ÎµÏ„Îµ Î´Î¹ÎºÎ±Î¯Ï‰Î¼Î± Î±Ï€ÏŒÏÏÎ¹ÏˆÎ·Ï‚.");
                    }
                    
                    // Update request status ÏƒÎµ Î‘Î ÎŸÎ¡Î¡Î™Î¦Î˜Î—ÎšÎ•
                    $update_sql = "
                        UPDATE requests 
                        SET status = 'Î‘Î ÎŸÎ¡Î¡Î™Î¦Î˜Î—ÎšÎ•',
                            rejected_by = ?,
                            rejected_at = NOW(),
                            rejection_reason = ?
                        WHERE id = ?
                    ";
                    $update_stmt = $pdo->prepare($update_sql);
                    $update_stmt->execute([$user_mitroo, $rejection_reason, $request_id]);
                    
                    $pdo->commit();
                    
                    // Email notification
                    $email_sent = sendRejectionEmail($pdo, $request_id, $rejection_reason);
                    
                    // Audit trail
                    logManagerAction($pdo, $user_mitroo, 'REJECT_REQUEST', [
                        'request_id' => $request_id,
                        'employee_mitroo' => $request['mitroo'],
                        'reason' => $rejection_reason
                    ]);
                    
                    $success = "âœ… Î— Î±Î¯Ï„Î·ÏƒÎ· Î±Ï€Î¿ÏÏÎ¯Ï†Î¸Î·ÎºÎµ.";
                    if ($email_sent) {
                        $success .= " Î£Ï„Î¬Î»Î¸Î·ÎºÎµ email ÎµÎ¹Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚.";
                    }
                    
                } catch (Exception $e) {
                    $pdo->rollback();
                    $error = "âŒ Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ Î±Ï€ÏŒÏÏÎ¹ÏˆÎ·: " . $e->getMessage();
                }
                break;
                
            case 'bulk_approve':
                /**
                 * ================================================================
                 * BULK Î•Î“ÎšÎ¡Î™Î£Î— Î ÎŸÎ›Î›Î‘Î Î›Î©Î Î‘Î™Î¤Î—Î£Î•Î©Î
                 * ================================================================
                 * 
                 * Î•Î Î™Î§Î•Î™Î¡Î—Î£Î™Î‘ÎšÎ— Î›ÎŸÎ“Î™ÎšÎ—:
                 * - Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Ï€Î¿Î»Î»Î±Ï€Î»ÏÎ½ Î±Î¹Ï„Î®ÏƒÎµÏ‰Î½ ÏƒÎµ Î¼Î¯Î± transaction
                 * - ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Ï…Ï€Î¿Î»Î¿Î¯Ï€Ï‰Î½ Î³Î¹Î± ÎºÎ¬Î¸Îµ Î±Î¯Ï„Î·ÏƒÎ· Î¾ÎµÏ‡Ï‰ÏÎ¹ÏƒÏ„Î¬
                 * - Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Î¼Î¯Î±Ï‚ Î±Î¯Ï„Î·ÏƒÎ·Ï‚ Î´ÎµÎ½ ÎµÏ€Î·ÏÎµÎ¬Î¶ÎµÎ¹ Ï„Î¹Ï‚ Î¬Î»Î»ÎµÏ‚
                 * - Detailed feedback Î³Î¹Î± ÎºÎ¬Î¸Îµ Î±Î¯Ï„Î·ÏƒÎ·
                 */
                
                $selected_requests = $_POST['selected_requests'] ?? [];
                $bulk_comments = trim($_POST['bulk_comments'] ?? '');
                
                if (empty($selected_requests)) {
                    $error = "âŒ Î”ÎµÎ½ ÎµÏ€Î¹Î»Î­Ï‡Î¸Î·ÎºÎ±Î½ Î±Î¹Ï„Î®ÏƒÎµÎ¹Ï‚ Î³Î¹Î± Î­Î³ÎºÏÎ¹ÏƒÎ·.";
                    break;
                }
                
                $approved_count = 0;
                $failed_requests = [];
                
                foreach ($selected_requests as $request_id) {
                    try {
                        $pdo->beginTransaction();
                        
                        // Î›Î®ÏˆÎ· Î±Î¯Ï„Î·ÏƒÎ·Ï‚ Î¼Îµ validation
                        $request_sql = "
                            SELECT r.*, u.ÎŸÎÎŸÎœÎ‘, u.Î•Î Î©ÎÎ¥ÎœÎŸ, u.EMAIL
                            FROM requests r
                            JOIN users u ON r.mitroo = u.ÎœÎ—Î¤Î¡Î©ÎŸ
                            WHERE r.id = ? AND r.status = 'Î•ÎšÎšÎ¡Î•ÎœÎ•Î™'
                        ";
                        
                        if (!$is_admin) {
                            $request_sql .= " AND r.selected_manager_mitroo = ?";
                            $stmt = $pdo->prepare($request_sql);
                            $stmt->execute([$request_id, $user_mitroo]);
                        } else {
                            $stmt = $pdo->prepare($request_sql);
                            $stmt->execute([$request_id]);
                        }
                        
                        $request = $stmt->fetch();
                        
                        if (!$request) {
                            throw new Exception("Î‘Î¯Ï„Î·ÏƒÎ· #$request_id Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ");
                        }
                        
                        // Balance check
                        $balance_check = checkLeaveBalance(
                            $pdo, 
                            $request['mitroo'], 
                            $request['typos'], 
                            $request['meres'], 
                            0, 
                            $request['wres']
                        );
                        
                        if (!$balance_check['status']) {
                            throw new Exception("Î‘Î½ÎµÏ€Î±ÏÎºÎ­Ï‚ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿ Î³Î¹Î± " . $request['ÎŸÎÎŸÎœÎ‘'] . " " . $request['Î•Î Î©ÎÎ¥ÎœÎŸ']);
                        }
                        
                        // Approve request
                        $update_sql = "
                            UPDATE requests 
                            SET status = 'Î•Î“ÎšÎ•ÎšÎ¡Î™ÎœÎ•ÎÎ—',
                                approved_by = ?,
                                approved_at = NOW(),
                                manager_comments = ?
                            WHERE id = ?
                        ";
                        $update_stmt = $pdo->prepare($update_sql);
                        $update_stmt->execute([$user_mitroo, $bulk_comments, $request_id]);
                        
                        // Update balance
                        updateUserBalance($pdo, $request['mitroo'], $request['typos'], $request['meres'], $request['wres']);
                        
                        $pdo->commit();
                        $approved_count++;
                        
                        // Send individual email
                        sendApprovalEmail($pdo, $request_id, $bulk_comments);
                        
                    } catch (Exception $e) {
                        $pdo->rollback();
                        $failed_requests[] = "Î‘Î¯Ï„Î·ÏƒÎ· #$request_id: " . $e->getMessage();
                    }
                }
                
                // Bulk operation feedback
                if ($approved_count > 0) {
                    $success = "âœ… Î•Î³ÎºÏÎ¯Î¸Î·ÎºÎ±Î½ $approved_count Î±Î¹Ï„Î®ÏƒÎµÎ¹Ï‚ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚.";
                }
                
                if (!empty($failed_requests)) {
                    $error = "âŒ Î‘Ï€Î¿Ï„Ï…Ï‡Î¯ÎµÏ‚:\n" . implode("\n", $failed_requests);
                }
                
                // Audit trail Î³Î¹Î± bulk operation
                logManagerAction($pdo, $user_mitroo, 'BULK_APPROVE', [
                    'approved_count' => $approved_count,
                    'failed_count' => count($failed_requests),
                    'requests' => $selected_requests
                ]);
                
                break;
                
            case 'bulk_reject':
                /**
                 * ================================================================
                 * BULK Î‘Î ÎŸÎ¡Î¡Î™Î¨Î— Î ÎŸÎ›Î›Î‘Î Î›Î©Î Î‘Î™Î¤Î—Î£Î•Î©Î
                 * ================================================================
                 */
                
                $selected_requests = $_POST['selected_requests'] ?? [];
                $bulk_rejection_reason = trim($_POST['bulk_rejection_reason'] ?? '');
                
                if (empty($selected_requests)) {
                    $error = "âŒ Î”ÎµÎ½ ÎµÏ€Î¹Î»Î­Ï‡Î¸Î·ÎºÎ±Î½ Î±Î¹Ï„Î®ÏƒÎµÎ¹Ï‚ Î³Î¹Î± Î±Ï€ÏŒÏÏÎ¹ÏˆÎ·.";
                    break;
                }
                
                if (empty($bulk_rejection_reason)) {
                    $error = "âŒ Î— Î±Î¹Ï„Î¹Î¿Î»Î¿Î³Î¯Î± bulk Î±Ï€ÏŒÏÏÎ¹ÏˆÎ·Ï‚ ÎµÎ¯Î½Î±Î¹ Ï…Ï€Î¿Ï‡ÏÎµÏ‰Ï„Î¹ÎºÎ®.";
                    break;
                }
                
                $rejected_count = 0;
                
                foreach ($selected_requests as $request_id) {
                    try {
                        $pdo->beginTransaction();
                        
                        $update_sql = "
                            UPDATE requests 
                            SET status = 'Î‘Î ÎŸÎ¡Î¡Î™Î¦Î˜Î—ÎšÎ•',
                                rejected_by = ?,
                                rejected_at = NOW(),
                                rejection_reason = ?
                            WHERE id = ? AND status = 'Î•ÎšÎšÎ¡Î•ÎœÎ•Î™'
                        ";
                        
                        if (!$is_admin) {
                            $update_sql .= " AND selected_manager_mitroo = ?";
                            $stmt = $pdo->prepare($update_sql);
                            $stmt->execute([$user_mitroo, $bulk_rejection_reason, $request_id, $user_mitroo]);
                        } else {
                            $stmt = $pdo->prepare($update_sql);
                            $stmt->execute([$user_mitroo, $bulk_rejection_reason, $request_id]);
                        }
                        
                        if ($stmt->rowCount() > 0) {
                            $pdo->commit();
                            $rejected_count++;
                            sendRejectionEmail($pdo, $request_id, $bulk_rejection_reason);
                        } else {
                            $pdo->rollback();
                        }
                        
                    } catch (Exception $e) {
                        $pdo->rollback();
                    }
                }
                
                $success = "âœ… Î‘Ï€Î¿ÏÏÎ¯Ï†Î¸Î·ÎºÎ±Î½ $rejected_count Î±Î¹Ï„Î®ÏƒÎµÎ¹Ï‚.";
                break;
        }
    }
}

// ========================================================================
// ÎšÎ‘Î¤Î‘Î£ÎšÎ•Î¥Î— ÎšÎ¥Î¡Î™ÎŸÎ¥ SQL QUERY ÎœÎ• Î¦Î™Î›Î¤Î¡Î‘
// ========================================================================

/**
 * Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± dynamic SQL query Î¼Îµ Î²Î¬ÏƒÎ· Ï„Î± Ï†Î¯Î»Ï„ÏÎ± ÎºÎ±Î¹ Ï„Î¿ role Ï„Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î·
 * 
 * SECURITY CONSIDERATIONS:
 * - Prepared statements Î³Î¹Î± ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ Ï€Î±ÏÎ±Î¼Î­Ï„ÏÎ¿Ï…Ï‚
 * - Role-based filtering (manager vs admin)
 * - Input validation Î³Î¹Î± sort fields
 * - Escape clauses Î³Î¹Î± LIKE queries
 */

// Î’Î±ÏƒÎ¹ÎºÏŒ SQL Î¼Îµ JOINs Î³Î¹Î± user ÎºÎ±Î¹ department info
$sql = "
    SELECT 
        r.*,
        u.ÎŸÎÎŸÎœÎ‘, u.Î•Î Î©ÎÎ¥ÎœÎŸ, u.EMAIL, u.Î¤ÎœÎ—ÎœÎ‘,
        m.ÎŸÎÎŸÎœÎ‘ as manager_name, m.Î•Î Î©ÎÎ¥ÎœÎŸ as manager_surname,
        DATEDIFF(r.imerominia, CURDATE()) as days_until_leave
    FROM requests r
    JOIN users u ON r.mitroo = u.ÎœÎ—Î¤Î¡Î©ÎŸ
    LEFT JOIN users m ON r.selected_manager_mitroo = m.ÎœÎ—Î¤Î¡Î©ÎŸ
    WHERE r.status = 'Î•ÎšÎšÎ¡Î•ÎœÎ•Î™'
";

// Parameters array Î³Î¹Î± prepared statement
$params = [];

// Role-based access control
if (!$is_admin) {
    // Managers Î²Î»Î­Ï€Î¿Ï…Î½ Î¼ÏŒÎ½Î¿ Î±Î¹Ï„Î®ÏƒÎµÎ¹Ï‚ Ï€Î¿Ï… Ï„Î¿Ï…Ï‚ Î­Ï‡Î¿Ï…Î½ Î±Î½Î±Ï„ÎµÎ¸ÎµÎ¯
    $sql .= " AND r.selected_manager_mitroo = ?";
    $params[] = $user_mitroo;
}

// Department filter
if ($filter_department !== 'ALL') {
    $sql .= " AND u.Î¤ÎœÎ—ÎœÎ‘ = ?";
    $params[] = $filter_department;
}

// Leave type filter
if ($filter_leave_type !== 'ALL') {
    $sql .= " AND r.typos = ?";
    $params[] = $filter_leave_type;
}

// Priority filter (Ï…Ï€Î¿Î»Î¿Î³Î¯Î¶ÎµÏ„Î±Î¹ Î²Î¬ÏƒÎµÎ¹ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±Ï‚ Î¬Î´ÎµÎ¹Î±Ï‚)
if ($filter_priority !== 'ALL') {
    switch ($filter_priority) {
        case 'URGENT':
            // Î†Î´ÎµÎ¹ÎµÏ‚ Ï€Î¿Ï… Î¾ÎµÎºÎ¹Î½Î¿ÏÎ½ ÏƒÎµ 3 Î·Î¼Î­ÏÎµÏ‚ Î® Î»Î¹Î³ÏŒÏ„ÎµÏÎ¿
            $sql .= " AND DATEDIFF(r.imerominia, CURDATE()) <= 3";
            break;
        case 'NORMAL':
            // Î†Î´ÎµÎ¹ÎµÏ‚ Ï€Î¿Ï… Î¾ÎµÎºÎ¹Î½Î¿ÏÎ½ ÏƒÎµ 4-14 Î·Î¼Î­ÏÎµÏ‚
            $sql .= " AND DATEDIFF(r.imerominia, CURDATE()) BETWEEN 4 AND 14";
            break;
        case 'LOW':
            // Î†Î´ÎµÎ¹ÎµÏ‚ Ï€Î¿Ï… Î¾ÎµÎºÎ¹Î½Î¿ÏÎ½ ÏƒÎµ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Î±Ï€ÏŒ 14 Î·Î¼Î­ÏÎµÏ‚
            $sql .= " AND DATEDIFF(r.imerominia, CURDATE()) > 14";
            break;
    }
}

// Date range filters
if (!empty($filter_date_from)) {
    $sql .= " AND r.imerominia >= ?";
    $params[] = $filter_date_from;
}

if (!empty($filter_date_to)) {
    $sql .= " AND r.imerominia <= ?";
    $params[] = $filter_date_to;
}

// Sorting validation ÎºÎ±Î¹ construction
$allowed_sort_fields = [
    'submitted_at' => 'r.submitted_at',
    'imerominia' => 'r.imerominia', 
    'typos' => 'r.typos',
    'employee_name' => 'u.Î•Î Î©ÎÎ¥ÎœÎŸ',
    'department' => 'u.Î¤ÎœÎ—ÎœÎ‘',
    'days_until' => 'days_until_leave',
    'meres' => 'r.meres'
];

$sort_field = $allowed_sort_fields[$sort_by] ?? 'r.submitted_at';
$sort_direction = strtoupper($sort_order) === 'DESC' ? 'DESC' : 'ASC';

$sql .= " ORDER BY $sort_field $sort_direction";

// ========================================================================
// PAGINATION CALCULATIONS
// ========================================================================

// Count query Î³Î¹Î± total results
$count_sql = preg_replace('/SELECT.*?FROM/s', 'SELECT COUNT(*) FROM', $sql);
$count_sql = preg_replace('/ORDER BY.*$/', '', $count_sql);

$count_stmt = $pdo->prepare($count_sql);
$count_stmt->execute($params);
$total_requests = $count_stmt->fetchColumn();

$total_pages = ceil($total_requests / $per_page);

// Add LIMIT Î³Î¹Î± pagination
$sql .= " LIMIT $per_page OFFSET $offset";

// ========================================================================
// Î•ÎšÎ¤Î•Î›Î•Î£Î— ÎšÎ¥Î¡Î™ÎŸÎ¥ QUERY
// ========================================================================

$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$requests = $stmt->fetchAll();

// ========================================================================
// Î£Î¥Î›Î›ÎŸÎ“Î— Î£Î¤Î‘Î¤Î™Î£Î¤Î™ÎšÎ©Î ÎšÎ‘Î™ METADATA
// ========================================================================

/**
 * Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬ Î³Î¹Î± dashboard ÎºÎ±Î¹ quick insights
 */

// Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬ ÎµÎºÎºÏÎµÎ¼ÏÎ½ Î±Î¹Ï„Î®ÏƒÎµÏ‰Î½
$stats_sql = "
    SELECT 
        COUNT(*) as total_pending,
        COUNT(CASE WHEN DATEDIFF(r.imerominia, CURDATE()) <= 3 THEN 1 END) as urgent,
        COUNT(CASE WHEN DATEDIFF(r.imerominia, CURDATE()) BETWEEN 4 AND 14 THEN 1 END) as normal,
        COUNT(CASE WHEN DATEDIFF(r.imerominia, CURDATE()) > 14 THEN 1 END) as low_priority,
        COUNT(CASE WHEN r.typos = 'ÎšÎ‘ÎÎŸÎÎ™ÎšÎ—' THEN 1 END) as regular_leaves,
        COUNT(CASE WHEN r.typos = 'ÎŸÎ›Î™Î“ÎŸÎ©Î¡Î—' THEN 1 END) as hourly_leaves,
        AVG(DATEDIFF(r.imerominia, r.submitted_at)) as avg_notice_days
    FROM requests r
    JOIN users u ON r.mitroo = u.ÎœÎ—Î¤Î¡Î©ÎŸ
    WHERE r.status = 'Î•ÎšÎšÎ¡Î•ÎœÎ•Î™'
";

if (!$is_admin) {
    $stats_sql .= " AND r.selected_manager_mitroo = ?";
    $stats_stmt = $pdo->prepare($stats_sql);
    $stats_stmt->execute([$user_mitroo]);
} else {
    $stats_stmt = $pdo->prepare($stats_sql);
    $stats_stmt->execute();
}

$stats = $stats_stmt->fetch();

// Departments list Î³Î¹Î± filter dropdown
$departments_sql = "
    SELECT DISTINCT u.Î¤ÎœÎ—ÎœÎ‘
    FROM requests r
    JOIN users u ON r.mitroo = u.ÎœÎ—Î¤Î¡Î©ÎŸ
    WHERE r.status = 'Î•ÎšÎšÎ¡Î•ÎœÎ•Î™'
";

if (!$is_admin) {
    $departments_sql .= " AND r.selected_manager_mitroo = ?";
    $dept_stmt = $pdo->prepare($departments_sql);
    $dept_stmt->execute([$user_mitroo]);
} else {
    $dept_stmt = $pdo->prepare($departments_sql);
    $dept_stmt->execute();
}

$departments = $dept_stmt->fetchAll(PDO::FETCH_COLUMN);

// Leave types Î³Î¹Î± filter
$leave_types_sql = "
    SELECT DISTINCT r.typos
    FROM requests r
    WHERE r.status = 'Î•ÎšÎšÎ¡Î•ÎœÎ•Î™'
";

if (!$is_admin) {
    $leave_types_sql .= " AND r.selected_manager_mitroo = ?";
    $types_stmt = $pdo->prepare($leave_types_sql);
    $types_stmt->execute([$user_mitroo]);
} else {
    $types_stmt = $pdo->prepare($leave_types_sql);
    $types_stmt->execute();
}

$leave_types = $types_stmt->fetchAll(PDO::FETCH_COLUMN);

// ========================================================================
// HELPER FUNCTIONS Î“Î™Î‘ UI FORMATTING
// ========================================================================

/**
 * Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Ï€ÏÎ¿Ï„ÎµÏÎ±Î¹ÏŒÏ„Î·Ï„Î±Ï‚ Î±Î¯Ï„Î·ÏƒÎ·Ï‚ Î²Î¬ÏƒÎµÎ¹ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±Ï‚
 * 
 * @param int $days_until Î—Î¼Î­ÏÎµÏ‚ Î¼Î­Ï‡ÏÎ¹ Ï„Î·Î½ Î¬Î´ÎµÎ¹Î±
 * @return array [priority_level, css_class, emoji]
 */
function calculatePriority($days_until) {
    if ($days_until <= 0) {
        return ['OVERDUE', 'priority-overdue', 'ğŸš¨'];
    } elseif ($days_until <= 3) {
        return ['URGENT', 'priority-urgent', 'âš¡'];
    } elseif ($days_until <= 14) {
        return ['NORMAL', 'priority-normal', 'ğŸ“…'];
    } else {
        return ['LOW', 'priority-low', 'ğŸ•'];
    }
}

/**
 * ÎœÎ¿ÏÏ†Î¿Ï€Î¿Î¯Î·ÏƒÎ· Ï„ÏÏ€Î¿Ï… Î¬Î´ÎµÎ¹Î±Ï‚ Î³Î¹Î± ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ·
 */
function formatLeaveTypeDisplay($type) {
    $types = [
        'ÎšÎ‘ÎÎŸÎÎ™ÎšÎ—' => ['name' => 'ÎšÎ±Î½Î¿Î½Î¹ÎºÎ® Î†Î´ÎµÎ¹Î±', 'emoji' => 'ğŸ–ï¸'],
        'Î’Î¡Î‘Î§Î•Î™Î‘' => ['name' => 'Î’ÏÎ±Ï‡ÎµÎ¯Î± Î†Î´ÎµÎ¹Î±', 'emoji' => 'ğŸ“…'],
        'ÎŸÎ›Î™Î“ÎŸÎ©Î¡Î—' => ['name' => 'ÎŸÎ»Î¹Î³ÏŒÏ‰ÏÎ· Î†Î´ÎµÎ¹Î±', 'emoji' => 'â°'],
        'Î‘ÎÎ‘Î¡Î¡Î©Î¤Î™ÎšÎ—' => ['name' => 'Î‘Î½Î±ÏÏÏ‰Ï„Î¹ÎºÎ®', 'emoji' => 'ğŸ¥'],
        'Î•ÎÎ•Î¤Î‘Î£Î•Î©Î' => ['name' => 'Î•Î¾ÎµÏ„Î¬ÏƒÎµÏ‰Î½', 'emoji' => 'ğŸ“š'],
        'ÎœÎ—Î¤Î¡ÎŸÎ¤Î—Î¤Î‘Î£' => ['name' => 'ÎœÎ·Ï„ÏÏŒÏ„Î·Ï„Î±Ï‚', 'emoji' => 'ğŸ‘¶'],
        'Î“Î‘ÎœÎŸÎ£' => ['name' => 'Î“Î¬Î¼Î¿Ï…', 'emoji' => 'ğŸ’’'],
        'Î Î•ÎÎ˜ÎŸÎ£' => ['name' => 'Î Î­Î½Î¸Î¿Ï…Ï‚', 'emoji' => 'ğŸ•Šï¸']
    ];
    
    return $types[$type] ?? ['name' => $type, 'emoji' => 'ğŸ“‹'];
}

/**
 * Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ business days Î¼ÎµÏ„Î±Î¾Ï Î´ÏÎ¿ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¹ÏÎ½
 */
function calculateBusinessDays($start_date, $end_date) {
    $start = new DateTime($start_date);
    $end = new DateTime($end_date);
    $interval = new DateInterval('P1D');
    $daterange = new DatePeriod($start, $interval, $end);
    
    $business_days = 0;
    foreach($daterange as $date){
        // Skip weekends (Saturday = 6, Sunday = 0)
        if($date->format('w') != 0 && $date->format('w') != 6) {
            $business_days++;
        }
    }
    
    return $business_days;
}

// ========================================================================
// GENERAR CSRF TOKEN Î“Î™Î‘ FORMS
// ========================================================================
$csrf_token = $_SESSION['csrf_token'];

?>

<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î•ÎºÎºÏÎµÎ¼ÎµÎ¯Ï‚ Î‘Î¹Ï„Î®ÏƒÎµÎ¹Ï‚ - Î£ÏÏƒÏ„Î·Î¼Î± Î‘Î´ÎµÎ¹ÏÎ½</title>
    
    <!-- ========================================================================
         CSS STYLES - ADVANCED MANAGEMENT INTERFACE
         ======================================================================== -->
    <style>
        /* === Î’Î‘Î£Î™ÎšÎ•Î£ Î¡Î¥Î˜ÎœÎ™Î£Î•Î™Î£ === */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container { 
            max-width: 1600px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        /* === HEADER SECTION === */
        .header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            color: #333;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .header h1 {
            font-size: 2.2rem;
            font-weight: 700;
            color: #667eea;
        }
        
        .header-info {
            text-align: right;
            font-size: 0.9rem;
            color: #666;
        }
        
        .manager-badge {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* === STATISTICS DASHBOARD === */
        .stats-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-top: 4px solid;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        
        .stat-card.total { border-top-color: #17a2b8; }
        .stat-card.urgent { border-top-color: #dc3545; }
        .stat-card.normal { border-top-color: #ffc107; }
        .stat-card.low { border-top-color: #28a745; }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        
        .stat-description {
            font-size: 0.8rem;
            color: #888;
            margin-top: 5px;
        }
        
        /* === FILTERS AND ACTIONS BAR === */
        .controls-section {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .filters-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 0.9rem;
        }
        
        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            background: white;
        }
        
        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }
        
        .bulk-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        /* === MAIN CONTENT TABLE === */
        .content-section {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .requests-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .requests-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .requests-table td {
            padding: 15px 12px;
            border-bottom: 1px solid #f1f3f4;
            vertical-align: middle;
        }
        
        .requests-table tr:hover {
            background-color: rgba(102, 126, 234, 0.05);
        }
        
        /* === PRIORITY INDICATORS === */
        .priority-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .priority-overdue { background: #dc3545; color: white; }
        .priority-urgent { background: #fd7e14; color: white; }
        .priority-normal { background: #ffc107; color: #212529; }
        .priority-low { background: #28a745; color: white; }
        
        /* === EMPLOYEE INFO DISPLAY === */
        .employee-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .employee-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .employee-details strong {
            display: block;
            color: #333;
        }
        
        .employee-details small {
            color: #666;
            font-size: 0.8rem;
        }
        
        /* === LEAVE TYPE BADGES === */
        .leave-type-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
        }
        
        /* === ACTION BUTTONS === */
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            text-align: center;
        }
        
        .btn-sm { padding: 6px 12px; font-size: 0.75rem; }
        .btn-xs { padding: 4px 8px; font-size: 0.7rem; }
        
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-primary { background: #007bff; color: white; }
        
        .btn:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.15); 
            filter: brightness(110%);
        }
        
        /* === BULK SELECTION === */
        .bulk-checkbox {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
        }
        
        .bulk-selected {
            background-color: rgba(102, 126, 234, 0.1) !important;
        }
        
        /* === MODALS === */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .modal-header h3 {
            color: #333;
            margin-bottom: 5px;
        }
        
        .modal-body textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }
        
        .modal-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* === PAGINATION === */
        .pagination-container {
            padding: 20px;
            border-top: 1px solid #f1f3f4;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(248,249,250,0.5);
        }
        
        .pagination {
            display: flex;
            gap: 5px;
        }
        
        .pagination a, .pagination span {
            padding: 10px 15px;
            border: 1px solid #dee2e6;
            color: #495057;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .pagination a:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }
        
        .pagination .current {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        
        /* === ALERTS === */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(10px);
        }
        
        .alert-success {
            background: rgba(212, 237, 218, 0.9);
            color: #155724;
            border-left-color: #28a745;
        }
        
        .alert-danger {
            background: rgba(248, 215, 218, 0.9);
            color: #721c24;
            border-left-color: #dc3545;
        }
        
        .alert-info {
            background: rgba(209, 236, 241, 0.9);
            color: #0c5460;
            border-left-color: #17a2b8;
        }
        
        /* === RESPONSIVE DESIGN === */
        @media (max-width: 1200px) {
            .container { padding: 15px; }
            .stats-dashboard { grid-template-columns: repeat(2, 1fr); }
            .filters-row { grid-template-columns: 1fr 1fr; }
        }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 1.8rem; }
            .header-content { flex-direction: column; text-align: center; }
            .stats-dashboard { grid-template-columns: 1fr; }
            .filters-row { grid-template-columns: 1fr; }
            .actions-bar { flex-direction: column; align-items: stretch; }
            
            .requests-table {
                font-size: 0.8rem;
            }
            
            .requests-table th,
            .requests-table td {
                padding: 10px 8px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                justify-content: center;
                width: 100%;
            }
        }
        
        /* === LOADING STATES === */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        
        /* === TOOLTIPS === */
        .tooltip {
            position: relative;
            cursor: help;
        }
        
        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 1000;
        }
        
        /* === BACK BUTTON === */
        .back-btn {
            background: rgba(255,255,255,0.9);
            color: #667eea;
            padding: 12px 20px;
            border: 2px solid #667eea;
            border-radius: 8px;
            text-decoration: none;
            margin-bottom: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ========================================================================
             HEADER SECTION - Î¤Î™Î¤Î›ÎŸÎ£ ÎšÎ‘Î™ MANAGER INFO
             ======================================================================== -->
        <div class="header">
            <div class="header-content">
                <div>
                    <h1>ğŸ“‹ Î•ÎºÎºÏÎµÎ¼ÎµÎ¯Ï‚ Î‘Î¹Ï„Î®ÏƒÎµÎ¹Ï‚ Î†Î´ÎµÎ¹Î±Ï‚</h1>
                    <p>Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· ÎºÎ±Î¹ Î­Î³ÎºÏÎ¹ÏƒÎ· Î±Î¹Ï„Î®ÏƒÎµÏ‰Î½ Î¬Î´ÎµÎ¹Î±Ï‚ Ï…Ï€Î±Î»Î»Î®Î»Ï‰Î½</p>
                </div>
                <div class="header-info">
                    <div class="manager-badge">
                        <?php echo $is_admin ? 'ğŸ‘‘ Administrator' : 'ğŸ‘¤ Î ÏÎ¿ÏŠÏƒÏ„Î¬Î¼ÎµÎ½Î¿Ï‚'; ?>
                    </div>
                    <div style="margin-top: 8px;">
                        <strong><?php echo htmlspecialchars($user_data['ÎŸÎÎŸÎœÎ‘'] . ' ' . $user_data['Î•Î Î©ÎÎ¥ÎœÎŸ']); ?></strong><br>
                        <small>ÎœÎ·Ï„ÏÏÎ¿: <?php echo htmlspecialchars($user_mitroo); ?></small>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÎšÎ¿Ï…Î¼Ï€Î¯ ÎµÏ€Î¹ÏƒÏ„ÏÎ¿Ï†Î®Ï‚ -->
        <a href="index.php" class="back-btn">
            â† Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î® ÏƒÏ„Î·Î½ Î‘ÏÏ‡Î¹ÎºÎ®
        </a>

        <!-- ========================================================================
             MESSAGES SECTION - Î•ÎœÎ¦Î‘ÎÎ™Î£Î— FEEDBACK ÎœÎ—ÎÎ¥ÎœÎ‘Î¤Î©Î
             ======================================================================== -->
        <?php if ($success): ?>
            <div class="alert alert-success">
                âœ… <?php echo htmlspecialchars($success); ?>
            </div>
        <?php endif; ?>

        <?php if ($error): ?>
            <div class="alert alert-danger">
                âŒ <?php echo nl2br(htmlspecialchars($error)); ?>
            </div>
        <?php endif; ?>

        <?php if ($info): ?>
            <div class="alert alert-info">
                â„¹ï¸ <?php echo htmlspecialchars($info); ?>
            </div>
        <?php endif; ?>

        <!-- ========================================================================
             STATISTICS DASHBOARD - Î£Î¤Î‘Î¤Î™Î£Î¤Î™ÎšÎ‘ Î•ÎšÎšÎ¡Î•ÎœÎ©Î Î‘Î™Î¤Î—Î£Î•Î©Î  
             ======================================================================== -->
        <div class="stats-dashboard">
            <div class="stat-card total">
                <div class="stat-number" style="color: #17a2b8;">
                    <?php echo $stats['total_pending'] ?? 0; ?>
                </div>
                <div class="stat-label">Î£Ï…Î½Î¿Î»Î¹ÎºÎ­Ï‚ Î•ÎºÎºÏÎµÎ¼ÎµÎ¯Ï‚</div>
                <div class="stat-description">
                    ÎœÎ­ÏƒÎ¿Ï‚ Ï‡ÏÏŒÎ½Î¿Ï‚ Ï€ÏÎ¿ÎµÎ¹Î´Î¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚: <?php echo round($stats['avg_notice_days'] ?? 0); ?> Î·Î¼Î­ÏÎµÏ‚
                </div>
            </div>

            <div class="stat-card urgent">
                <div class="stat-number" style="color: #dc3545;">
                    <?php echo $stats['urgent'] ?? 0; ?>
                </div>
                <div class="stat-label">Î•Ï€ÎµÎ¯Î³Î¿Ï…ÏƒÎµÏ‚</div>
                <div class="stat-description">
                    Î†Î´ÎµÎ¹ÎµÏ‚ Ï€Î¿Ï… Î¾ÎµÎºÎ¹Î½Î¿ÏÎ½ ÏƒÎµ â‰¤3 Î·Î¼Î­ÏÎµÏ‚
                </div>
            </div>

            <div class="stat-card normal">
                <div class="stat-number" style="color: #ffc107;">
                    <?php echo $stats['normal'] ?? 0; ?>
                </div>
                <div class="stat-label">ÎšÎ±Î½Î¿Î½Î¹ÎºÎ­Ï‚</div>
                <div class="stat-description">
                    Î†Î´ÎµÎ¹ÎµÏ‚ Ï€Î¿Ï… Î¾ÎµÎºÎ¹Î½Î¿ÏÎ½ ÏƒÎµ 4-14 Î·Î¼Î­ÏÎµÏ‚
                </div>
            </div>

            <div class="stat-card low">
                <div class="stat-number" style="color: #28a745;">
                    <?php echo $stats['low_priority'] ?? 0; ?>
                </div>
                <div class="stat-label">Î§Î±Î¼Î·Î»Î® Î ÏÎ¿Ï„ÎµÏÎ±Î¹ÏŒÏ„Î·Ï„Î±</div>
                <div class="stat-description">
                    Î†Î´ÎµÎ¹ÎµÏ‚ Ï€Î¿Ï… Î¾ÎµÎºÎ¹Î½Î¿ÏÎ½ ÏƒÎµ >14 Î·Î¼Î­ÏÎµÏ‚
                </div>
            </div>
        </div>

        <!-- ========================================================================
             FILTERS AND CONTROLS SECTION - Î¦Î™Î›Î¤Î¡Î‘ ÎšÎ‘Î™ BULK ACTIONS
             ======================================================================== -->
        <div class="controls-section">
            <form method="GET" id="filters-form">
                <div class="filters-row">
                    <!-- Department Filter -->
                    <div class="filter-group">
                        <label for="department">ğŸ¢ Î¤Î¼Î®Î¼Î±:</label>
                        <select name="department" id="department" onchange="applyFilters()">
                            <option value="ALL" <?php echo $filter_department === 'ALL' ? 'selected' : ''; ?>>
                                ÎŒÎ»Î± Ï„Î± Ï„Î¼Î®Î¼Î±Ï„Î±
                            </option>
                            <?php foreach ($departments as $dept): ?>
                                <option value="<?php echo htmlspecialchars($dept); ?>" 
                                        <?php echo $filter_department === $dept ? 'selected' : ''; ?>>
                                    <?php echo htmlspecialchars($dept); ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    </div>

                    <!-- Leave Type Filter -->
                    <div class="filter-group">
                        <label for="leave_type">ğŸ“‹ Î¤ÏÏ€Î¿Ï‚ Î†Î´ÎµÎ¹Î±Ï‚:</label>
                        <select name="leave_type" id="leave_type" onchange="applyFilters()">
                            <option value="ALL" <?php echo $filter_leave_type === 'ALL' ? 'selected' : ''; ?>>
                                ÎŒÎ»Î¿Î¹ Î¿Î¹ Ï„ÏÏ€Î¿Î¹
                            </option>
                            <?php foreach ($leave_types as $type): ?>
                                <?php $type_info = formatLeaveTypeDisplay($type); ?>
                                <option value="<?php echo htmlspecialchars($type); ?>" 
                                        <?php echo $filter_leave_type === $type ? 'selected' : ''; ?>>
                                    <?php echo $type_info['emoji'] . ' ' . htmlspecialchars($type_info['name']); ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    </div>

                    <!-- Priority Filter -->
                    <div class="filter-group">
                        <label for="priority">âš¡ Î ÏÎ¿Ï„ÎµÏÎ±Î¹ÏŒÏ„Î·Ï„Î±:</label>
                        <select name="priority" id="priority" onchange="applyFilters()">
                            <option value="ALL" <?php echo $filter_priority === 'ALL' ? 'selected' : ''; ?>>
                                ÎŒÎ»ÎµÏ‚ Î¿Î¹ Ï€ÏÎ¿Ï„ÎµÏÎ±Î¹ÏŒÏ„Î·Ï„ÎµÏ‚
                            </option>
                            <option value="URGENT" <?php echo $filter_priority === 'URGENT' ? 'selected' : ''; ?>>
                                ğŸš¨ Î•Ï€ÎµÎ¯Î³Î¿Ï…ÏƒÎµÏ‚ (â‰¤3 Î·Î¼Î­ÏÎµÏ‚)
                            </option>
                            <option value="NORMAL" <?php echo $filter_priority === 'NORMAL' ? 'selected' : ''; ?>>
                                ğŸ“… ÎšÎ±Î½Î¿Î½Î¹ÎºÎ­Ï‚ (4-14 Î·Î¼Î­ÏÎµÏ‚)
                            </option>
                            <option value="LOW" <?php echo $filter_priority === 'LOW' ? 'selected' : ''; ?>>
                                ğŸ• Î§Î±Î¼Î·Î»Î® (>14 Î·Î¼Î­ÏÎµÏ‚)
                            </option>
                        </select>
                    </div>

                    <!-- Date From -->
                    <div class="filter-group">
                        <label for="date_from">ğŸ“… Î†Î´ÎµÎ¹Î± Î±Ï€ÏŒ:</label>
                        <input type="date" name="date_from" id="date_from" 
                               value="<?php echo htmlspecialchars($filter_date_from); ?>" 
                               onchange="applyFilters()">
                    </div>

                    <!-- Date To -->
                    <div class="filter-group">
                        <label for="date_to">ğŸ“… Î†Î´ÎµÎ¹Î± Î­Ï‰Ï‚:</label>
                        <input type="date" name="date_to" id="date_to" 
                               value="<?php echo htmlspecialchars($filter_date_to); ?>" 
                               onchange="applyFilters()">
                    </div>

                    <!-- Sorting -->
                    <div class="filter-group">
                        <label for="sort">ğŸ“Š Î¤Î±Î¾Î¹Î½ÏŒÎ¼Î·ÏƒÎ·:</label>
                        <select name="sort" id="sort" onchange="applyFilters()">
                            <option value="submitted_at" <?php echo $sort_by === 'submitted_at' ? 'selected' : ''; ?>>
                                Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± Î¥Ï€Î¿Î²Î¿Î»Î®Ï‚
                            </option>
                            <option value="imerominia" <?php echo $sort_by === 'imerominia' ? 'selected' : ''; ?>>
                                Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± Î†Î´ÎµÎ¹Î±Ï‚
                            </option>
                            <option value="days_until" <?php echo $sort_by === 'days_until' ? 'selected' : ''; ?>>
                                Î—Î¼Î­ÏÎµÏ‚ Î¼Î­Ï‡ÏÎ¹ Ï„Î·Î½ Î¬Î´ÎµÎ¹Î±
                            </option>
                            <option value="employee_name" <?php echo $sort_by === 'employee_name' ? 'selected' : ''; ?>>
                                ÎŒÎ½Î¿Î¼Î± Î¥Ï€Î±Î»Î»Î®Î»Î¿Ï…
                            </option>
                            <option value="department" <?php echo $sort_by === 'department' ? 'selected' : ''; ?>>
                                Î¤Î¼Î®Î¼Î±
                            </option>
                            <option value="typos" <?php echo $sort_by === 'typos' ? 'selected' : ''; ?>>
                                Î¤ÏÏ€Î¿Ï‚ Î†Î´ÎµÎ¹Î±Ï‚
                            </option>
                        </select>
                    </div>

                    <!-- Sort Order -->
                    <div class="filter-group">
                        <label for="order">ğŸ”„ Î£ÎµÎ¹ÏÎ¬:</label>
                        <select name="order" id="order" onchange="applyFilters()">
                            <option value="ASC" <?php echo $sort_order === 'ASC' ? 'selected' : ''; ?>>
                                Î‘ÏÎ¾Î¿Ï…ÏƒÎ± â¬†ï¸
                            </option>
                            <option value="DESC" <?php echo $sort_order === 'DESC' ? 'selected' : ''; ?>>
                                Î¦Î¸Î¯Î½Î¿Ï…ÏƒÎ± â¬‡ï¸
                            </option>
                        </select>
                    </div>
                </div>

                <!-- Hidden field Î³Î¹Î± Î´Î¹Î±Ï„Î®ÏÎ·ÏƒÎ· ÏƒÎµÎ»Î¯Î´Î±Ï‚ -->
                <input type="hidden" name="page" value="1">
            </form>

            <!-- Bulk Actions Bar -->
            <div class="actions-bar">
                <div class="bulk-actions">
                    <label>
                        <input type="checkbox" id="select-all" class="bulk-checkbox"> 
                        Î•Ï€Î¹Î»Î¿Î³Î® ÏŒÎ»Ï‰Î½
                    </label>
                    <button type="button" class="btn btn-success btn-sm" onclick="showBulkApproveModal()" disabled id="bulk-approve-btn">
                        âœ… Bulk ÎˆÎ³ÎºÏÎ¹ÏƒÎ·
                    </button>
                    <button type="button" class="btn btn-danger btn-sm" onclick="showBulkRejectModal()" disabled id="bulk-reject-btn">
                        âŒ Bulk Î‘Ï€ÏŒÏÏÎ¹ÏˆÎ·
                    </button>
                    <span id="selected-count" class="selected-count">0 ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½ÎµÏ‚</span>
                </div>

                <div class="quick-actions">
                    <button type="button" class="btn btn-info btn-sm" onclick="exportRequests('pdf')">
                        ğŸ“„ Export PDF
                    </button>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="exportRequests('excel')">
                        ğŸ“Š Export Excel
                    </button>
                    <button type="button" class="btn btn-primary btn-sm" onclick="location.reload()">
                        ğŸ”„ Î‘Î½Î±Î½Î­Ï‰ÏƒÎ·
                    </button>
                </div>
            </div>
        </div>

        <!-- ========================================================================
             MAIN CONTENT - Î Î™ÎÎ‘ÎšÎ‘Î£ Î•ÎšÎšÎ¡Î•ÎœÎ©Î Î‘Î™Î¤Î—Î£Î•Î©Î
             ======================================================================== -->
        <div class="content-section">
            <?php if (empty($requests)): ?>
                <!-- Empty State -->
                <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                    <div style="font-size: 4rem; margin-bottom: 20px; opacity: 0.5;">ğŸ‰</div>
                    <h3 style="margin-bottom: 10px; color: #495057;">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎµÎºÎºÏÎµÎ¼ÎµÎ¯Ï‚ Î±Î¹Ï„Î®ÏƒÎµÎ¹Ï‚!</h3>
                    <p>
                        <?php if ($filter_department !== 'ALL' || $filter_leave_type !== 'ALL' || $filter_priority !== 'ALL'): ?>
                            Î”Î¿ÎºÎ¹Î¼Î¬ÏƒÏ„Îµ Î½Î± Î±Î»Î»Î¬Î¾ÎµÏ„Îµ Ï„Î± Ï†Î¯Î»Ï„ÏÎ± Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ·Ï‚.
                        <?php else: ?>
                            ÎŒÎ»ÎµÏ‚ Î¿Î¹ Î±Î¹Ï„Î®ÏƒÎµÎ¹Ï‚ Î­Ï‡Î¿Ï…Î½ Î´Î¹ÎµÎºÏ€ÎµÏÎ±Î¹Ï‰Î¸ÎµÎ¯.
                        <?php endif; ?>
                    </p>
                </div>
            <?php else: ?>
                <!-- Requests Table -->
                <table class="requests-table">
                    <thead>
                        <tr>
                            <th width="40">
                                <input type="checkbox" id="select-all-header" class="bulk-checkbox">
                            </th>
                            <th>ğŸ‘¤ Î¥Ï€Î¬Î»Î»Î·Î»Î¿Ï‚</th>
                            <th>ğŸ“‹ Î¤ÏÏ€Î¿Ï‚ Î†Î´ÎµÎ¹Î±Ï‚</th>
                            <th>ğŸ“… Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± Î†Î´ÎµÎ¹Î±Ï‚</th>
                            <th>â±ï¸ Î”Î¹Î¬ÏÎºÎµÎ¹Î±</th>
                            <th>âš¡ Î ÏÎ¿Ï„ÎµÏÎ±Î¹ÏŒÏ„Î·Ï„Î±</th>
                            <th>ğŸ“¤ Î¥Ï€Î¿Î²Î»Î®Î¸Î·ÎºÎµ</th>
                            <th>ğŸ“ Î›ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹ÎµÏ‚</th>
                            <th>âš¡ Î•Î½Î­ÏÎ³ÎµÎ¹ÎµÏ‚</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($requests as $request): ?>
                            <?php 
                            $priority = calculatePriority($request['days_until_leave']);
                            $leave_type_info = formatLeaveTypeDisplay($request['typos']);
                            ?>
                            <tr data-request-id="<?php echo $request['id']; ?>" class="request-row">
                                <!-- Bulk Selection Checkbox -->
                                <td>
                                    <input type="checkbox" name="bulk_select" value="<?php echo $request['id']; ?>" 
                                           class="bulk-checkbox request-checkbox">
                                </td>

                                <!-- Employee Info -->
                                <td>
                                    <div class="employee-info">
                                        <div class="employee-avatar">
                                            <?php echo strtoupper(substr($request['ÎŸÎÎŸÎœÎ‘'], 0, 1) . substr($request['Î•Î Î©ÎÎ¥ÎœÎŸ'], 0, 1)); ?>
                                        </div>
                                        <div class="employee-details">
                                            <strong><?php echo htmlspecialchars($request['ÎŸÎÎŸÎœÎ‘'] . ' ' . $request['Î•Î Î©ÎÎ¥ÎœÎŸ']); ?></strong>
                                            <small>
                                                <?php echo htmlspecialchars($request['Î¤ÎœÎ—ÎœÎ‘']); ?> | 
                                                ÎœÎ·Ï„ÏÏÎ¿: <?php echo htmlspecialchars($request['mitroo']); ?>
                                            </small>
                                        </div>
                                    </div>
                                </td>

                                <!-- Leave Type -->
                                <td>
                                    <div class="leave-type-badge">
                                        <?php echo $leave_type_info['emoji']; ?>
                                        <?php echo htmlspecialchars($leave_type_info['name']); ?>
                                    </div>
                                </td>

                                <!-- Leave Date -->
                                <td>
                                    <strong><?php echo date('d/m/Y', strtotime($request['imerominia'])); ?></strong>
                                    <br>
                                    <small style="color: #666;">
                                        <?php echo date('l', strtotime($request['imerominia'])); ?>
                                    </small>
                                </td>

                                <!-- Duration -->
                                <td>
                                    <?php if ($request['typos'] === 'ÎŸÎ›Î™Î“ÎŸÎ©Î¡Î—'): ?>
                                        <strong><?php echo $request['wres']; ?> ÏÏÎµÏ‚</strong>
                                        <?php if ($request['ora_enarxis'] && $request['ora_lixis']): ?>
                                            <br>
                                            <small style="color: #666;">
                                                <?php echo substr($request['ora_enarxis'], 0, 5) . '-' . substr($request['ora_lixis'], 0, 5); ?>
                                            </small>
                                        <?php endif; ?>
                                    <?php else: ?>
                                        <strong><?php echo $request['meres']; ?> Î·Î¼Î­ÏÎµÏ‚</strong>
                                        <br>
                                        <small style="color: #666;">
                                            <?php echo calculateBusinessDays($request['imerominia'], date('Y-m-d', strtotime($request['imerominia'] . ' +' . $request['meres'] . ' days'))); ?> ÎµÏÎ³Î¬ÏƒÎ¹Î¼ÎµÏ‚
                                        </small>
                                    <?php endif; ?>
                                </td>

                                <!-- Priority -->
                                <td>
                                    <div class="priority-indicator <?php echo $priority[1]; ?>">
                                        <?php echo $priority[2]; ?>
                                        <?php if ($request['days_until_leave'] <= 0): ?>
                                            Î•ÎšÎ Î¡ÎŸÎ˜Î•Î£ÎœÎ—
                                        <?php elseif ($request['days_until_leave'] == 1): ?>
                                            Î‘Î¥Î¡Î™ÎŸ
                                        <?php else: ?>
                                            <?php echo $request['days_until_leave']; ?> Î·Î¼Î­ÏÎµÏ‚
                                        <?php endif; ?>
                                    </div>
                                </td>

                                <!-- Submitted Date -->
                                <td>
                                    <strong><?php echo date('d/m/Y', strtotime($request['submitted_at'])); ?></strong>
                                    <br>
                                    <small style="color: #666;">
                                        <?php echo date('H:i', strtotime($request['submitted_at'])); ?>
                                    </small>
                                </td>

                                <!-- Details -->
                                <td>
                                    <?php if (!empty($request['logos'])): ?>
                                        <div class="tooltip" data-tooltip="<?php echo htmlspecialchars($request['logos']); ?>">
                                            <small style="color: #666;">
                                                <?php echo htmlspecialchars(substr($request['logos'], 0, 30)) . (strlen($request['logos']) > 30 ? '...' : ''); ?>
                                            </small>
                                        </div>
                                    <?php endif; ?>
                                    
                                    <?php if (!empty($request['topos_dianysis'])): ?>
                                        <br>
                                        <small style="color: #888;">
                                            ğŸ“ <?php echo htmlspecialchars($request['topos_dianysis']); ?>
                                        </small>
                                    <?php endif; ?>
                                </td>

                                <!-- Actions -->
                                <td>
                                    <div class="action-buttons">
                                        <!-- View Details -->
                                        <button type="button" class="btn btn-info btn-xs" 
                                                onclick="viewRequestDetails(<?php echo $request['id']; ?>)"
                                                title="Î ÏÎ¿Î²Î¿Î»Î® Î»ÎµÏ€Ï„Î¿Î¼ÎµÏÎµÎ¹ÏÎ½">
                                            ğŸ‘ï¸ Î ÏÎ¿Î²Î¿Î»Î®
                                        </button>

                                        <!-- Approve -->
                                        <button type="button" class="btn btn-success btn-xs" 
                                                onclick="showApproveModal(<?php echo $request['id']; ?>)"
                                                title="ÎˆÎ³ÎºÏÎ¹ÏƒÎ· Î±Î¯Ï„Î·ÏƒÎ·Ï‚">
                                            âœ… ÎˆÎ³ÎºÏÎ¹ÏƒÎ·
                                        </button>

                                        <!-- Reject -->
                                        <button type="button" class="btn btn-danger btn-xs" 
                                                onclick="showRejectModal(<?php echo $request['id']; ?>)"
                                                title="Î‘Ï€ÏŒÏÏÎ¹ÏˆÎ· Î±Î¯Ï„Î·ÏƒÎ·Ï‚">
                                            âŒ Î‘Ï€ÏŒÏÏÎ¹ÏˆÎ·
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>

                <!-- ========================================================================
                     PAGINATION SECTION
                     ======================================================================== -->
                <?php if ($total_pages > 1): ?>
                    <div class="pagination-container">
                        <div class="pagination-info">
                            Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· <?php echo count($requests); ?> Î±Ï€ÏŒ <?php echo $total_requests; ?> ÏƒÏ…Î½Î¿Î»Î¹ÎºÎ¬ 
                            (Î£ÎµÎ»Î¯Î´Î± <?php echo $page; ?> Î±Ï€ÏŒ <?php echo $total_pages; ?>)
                        </div>
                        
                        <div class="pagination">
                            <!-- First Page -->
                            <?php if ($page > 1): ?>
                                <a href="?<?php echo http_build_query(array_merge($_GET, ['page' => 1])); ?>">
                                    â®ï¸ Î ÏÏÏ„Î·
                                </a>
                            <?php endif; ?>

                            <!-- Previous Page -->
                            <?php if ($page > 1): ?>
                                <a href="?<?php echo http_build_query(array_merge($_GET, ['page' => $page - 1])); ?>">
                                    â† Î ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î·
                                </a>
                            <?php endif; ?>

                            <!-- Page Numbers -->
                            <?php 
                            $start_page = max(1, $page - 2);
                            $end_page = min($total_pages, $page + 2);
                            
                            for ($i = $start_page; $i <= $end_page; $i++): 
                            ?>
                                <?php if ($i == $page): ?>
                                    <span class="current"><?php echo $i; ?></span>
                                <?php else: ?>
                                    <a href="?<?php echo http_build_query(array_merge($_GET, ['page' => $i])); ?>">
                                        <?php echo $i; ?>
                                    </a>
                                <?php endif; ?>
                            <?php endfor; ?>

                            <!-- Next Page -->
                            <?php if ($page < $total_pages): ?>
                                <a href="?<?php echo http_build_query(array_merge($_GET, ['page' => $page + 1])); ?>">
                                    Î•Ï€ÏŒÎ¼ÎµÎ½Î· â†’
                                </a>
                            <?php endif; ?>

                            <!-- Last Page -->
                            <?php if ($page < $total_pages): ?>
                                <a href="?<?php echo http_build_query(array_merge($_GET, ['page' => $total_pages])); ?>">
                                    Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± â­ï¸
                                </a>
                            <?php endif; ?>
                        </div>
                    </div>
                <?php endif; ?>
            <?php endif; ?>
        </div>
    </div>

    <!-- ========================================================================
         MODAL WINDOWS - APPROVE, REJECT, BULK OPERATIONS
         ======================================================================== -->

    <!-- Approve Modal -->
    <div id="approve-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>âœ… ÎˆÎ³ÎºÏÎ¹ÏƒÎ· Î‘Î¯Ï„Î·ÏƒÎ·Ï‚</h3>
                <p>Î ÏÎ¿ÏƒÎ¸Î­ÏƒÏ„Îµ ÏƒÏ‡ÏŒÎ»Î¹Î± Ï€ÏÎ¿ÏŠÏƒÏ„Î±Î¼Î­Î½Î¿Ï… (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ)</p>
            </div>
            <form method="POST" id="approve-form">
                <input type="hidden" name="csrf_token" value="<?php echo $csrf_token; ?>">
                <input type="hidden" name="action" value="approve_request">
                <input type="hidden" name="request_id" id="approve-request-id">
                
                <div class="modal-body">
                    <label for="manager_comments">ğŸ’¬ Î£Ï‡ÏŒÎ»Î¹Î± Î ÏÎ¿ÏŠÏƒÏ„Î±Î¼Î­Î½Î¿Ï…:</label>
                    <textarea name="manager_comments" id="manager_comments" 
                              placeholder="Î ÏÎ¿ÏƒÎ¸Î­ÏƒÏ„Îµ ÏƒÏ‡ÏŒÎ»Î¹Î± Î³Î¹Î± Ï„Î·Î½ Î­Î³ÎºÏÎ¹ÏƒÎ· (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ)"></textarea>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('approve-modal')">
                        Î‘ÎºÏÏÏ‰ÏƒÎ·
                    </button>
                    <button type="submit" class="btn btn-success">
                        âœ… ÎˆÎ³ÎºÏÎ¹ÏƒÎ· Î‘Î¯Ï„Î·ÏƒÎ·Ï‚
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Reject Modal -->
    <div id="reject-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>âŒ Î‘Ï€ÏŒÏÏÎ¹ÏˆÎ· Î‘Î¯Ï„Î·ÏƒÎ·Ï‚</h3>
                <p>Î— Î±Î¹Ï„Î¹Î¿Î»Î¿Î³Î¯Î± Î±Ï€ÏŒÏÏÎ¹ÏˆÎ·Ï‚ ÎµÎ¯Î½Î±Î¹ Ï…Ï€Î¿Ï‡ÏÎµÏ‰Ï„Î¹ÎºÎ®</p>
            </div>
            <form method="POST" id="reject-form">
                <input type="hidden" name="csrf_token" value="<?php echo $csrf_token; ?>">
                <input type="hidden" name="action" value="reject_request">
                <input type="hidden" name="request_id" id="reject-request-id">
                
                <div class="modal-body">
                    <label for="rejection_reason">ğŸ“ Î‘Î¹Ï„Î¹Î¿Î»Î¿Î³Î¯Î± Î‘Ï€ÏŒÏÏÎ¹ÏˆÎ·Ï‚ *:</label>
                    <textarea name="rejection_reason" id="rejection_reason" required
                              placeholder="Î‘Î½Î±Ï†Î­ÏÎµÏ„Îµ Ï„Î¿Ï…Ï‚ Î»ÏŒÎ³Î¿Ï…Ï‚ Î±Ï€ÏŒÏÏÎ¹ÏˆÎ·Ï‚ Ï„Î·Ï‚ Î±Î¯Ï„Î·ÏƒÎ·Ï‚..."></textarea>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('reject-modal')">
                        Î‘ÎºÏÏÏ‰ÏƒÎ·
                    </button>
                    <button type="submit" class="btn btn-danger">
                        âŒ Î‘Ï€ÏŒÏÏÎ¹ÏˆÎ· Î‘Î¯Ï„Î·ÏƒÎ·Ï‚
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bulk Approve Modal -->
    <div id="bulk-approve-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>âœ… Bulk ÎˆÎ³ÎºÏÎ¹ÏƒÎ· Î‘Î¹Ï„Î®ÏƒÎµÏ‰Î½</h3>
                <p>ÎˆÎ³ÎºÏÎ¹ÏƒÎ· Ï€Î¿Î»Î»Î±Ï€Î»ÏÎ½ Î±Î¹Ï„Î®ÏƒÎµÏ‰Î½ Ï„Î±Ï…Ï„ÏŒÏ‡ÏÎ¿Î½Î±</p>
            </div>
            <form method="POST" id="bulk-approve-form">
                <input type="hidden" name="csrf_token" value="<?php echo $csrf_token; ?>">
                <input type="hidden" name="action" value="bulk_approve">
                <div id="bulk-approve-requests"></div>
                
                <div class="modal-body">
                    <label for="bulk_comments">ğŸ’¬ ÎšÎ¿Î¹Î½Î¬ Î£Ï‡ÏŒÎ»Î¹Î±:</label>
                    <textarea name="bulk_comments" id="bulk_comments" 
                              placeholder="ÎšÎ¿Î¹Î½Î¬ ÏƒÏ‡ÏŒÎ»Î¹Î± Î³Î¹Î± ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ ÎµÎ³ÎºÏÎ¯ÏƒÎµÎ¹Ï‚ (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ)"></textarea>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('bulk-approve-modal')">
                        Î‘ÎºÏÏÏ‰ÏƒÎ·
                    </button>
                    <button type="submit" class="btn btn-success">
                        âœ… ÎˆÎ³ÎºÏÎ¹ÏƒÎ· ÎŒÎ»Ï‰Î½
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bulk Reject Modal -->
    <div id="bulk-reject-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>âŒ Bulk Î‘Ï€ÏŒÏÏÎ¹ÏˆÎ· Î‘Î¹Ï„Î®ÏƒÎµÏ‰Î½</h3>
                <p>Î‘Ï€ÏŒÏÏÎ¹ÏˆÎ· Ï€Î¿Î»Î»Î±Ï€Î»ÏÎ½ Î±Î¹Ï„Î®ÏƒÎµÏ‰Î½ Ï„Î±Ï…Ï„ÏŒÏ‡ÏÎ¿Î½Î±</p>
            </div>
            <form method="POST" id="bulk-reject-form">
                <input type="hidden" name="csrf_token" value="<?php echo $csrf_token; ?>">
                <input type="hidden" name="action" value="bulk_reject">
                <div id="bulk-reject-requests"></div>
                
                <div class="modal-body">
                    <label for="bulk_rejection_reason">ğŸ“ ÎšÎ¿Î¹Î½Î® Î‘Î¹Ï„Î¹Î¿Î»Î¿Î³Î¯Î± Î‘Ï€ÏŒÏÏÎ¹ÏˆÎ·Ï‚ *:</label>
                    <textarea name="bulk_rejection_reason" id="bulk_rejection_reason" required
                              placeholder="ÎšÎ¿Î¹Î½Î® Î±Î¹Ï„Î¹Î¿Î»Î¿Î³Î¯Î± Î³Î¹Î± ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ Î±Ï€Î¿ÏÏÎ¯ÏˆÎµÎ¹Ï‚..."></textarea>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('bulk-reject-modal')">
                        Î‘ÎºÏÏÏ‰ÏƒÎ·
                    </button>
                    <button type="submit" class="btn btn-danger">
                        âŒ Î‘Ï€ÏŒÏÏÎ¹ÏˆÎ· ÎŒÎ»Ï‰Î½
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ========================================================================
         JAVASCRIPT SECTION - ADVANCED MANAGEMENT FUNCTIONALITY
         ======================================================================== -->
    <script>
        /**
         * ========================================================================
         * PENDING REQUESTS MANAGEMENT SYSTEM - CLIENT-SIDE FUNCTIONALITY
         * ========================================================================
         * 
         * Î Î•Î¡Î™Î“Î¡Î‘Î¦Î—:
         * Î ÏÎ¿Î·Î³Î¼Î­Î½Î· JavaScript ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Î³Î¹Î± Î´Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· ÎµÎºÎºÏÎµÎ¼ÏÎ½ Î±Î¹Ï„Î®ÏƒÎµÏ‰Î½.
         * Î Î±ÏÎ­Ï‡ÎµÎ¹ real-time UI updates, bulk operations, AJAX functionality,
         * form validation ÎºÎ±Î¹ enhanced UX features.
         * 
         * ÎšÎ¥Î¡Î™Î•Î£ Î›Î•Î™Î¤ÎŸÎ¥Î¡Î“Î™Î•Î£:
         * - Bulk selection ÎºÎ±Î¹ operations
         * - Modal management Î³Î¹Î± approve/reject
         * - AJAX communications
         * - Form validation
         * - Keyboard shortcuts
         * - Auto-refresh functionality
         * - Export operations
         * - Enhanced filtering
         * ========================================================================
         */

        // Global variables ÎºÎ±Î¹ state management
        let selectedRequests = new Set();
        let autoRefreshInterval = null;
        let lastUpdateCheck = new Date().toISOString();

        /**
         * ================================================================
         * INITIALIZATION - Î•ÎšÎšÎ™ÎÎ—Î£Î— Î•Î¦Î‘Î¡ÎœÎŸÎ“Î—Î£
         * ================================================================
         */
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ Pending Requests Management System loaded');
            
            // Initialize bulk selection functionality
            initializeBulkSelection();
            
            // Setup keyboard shortcuts
            setupKeyboardShortcuts();
            
            // Initialize auto-refresh
            initializeAutoRefresh();
            
            // Setup form validations
            setupFormValidations();
            
            // Initialize tooltips
            initializeTooltips();
            
            console.log(`ğŸ“Š Loaded ${document.querySelectorAll('.request-row').length} pending requests`);
            console.log(`ğŸ‘¤ User Role: ${<?php echo $is_admin ? '"Administrator"' : '"Manager"'; ?>}`);
        });

        /**
         * ================================================================
         * BULK SELECTION FUNCTIONALITY
         * ================================================================
         * 
         * Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· ÎµÏ€Î¹Î»Î¿Î³Î®Ï‚ Ï€Î¿Î»Î»Î±Ï€Î»ÏÎ½ Î±Î¹Ï„Î®ÏƒÎµÏ‰Î½ Î³Î¹Î± bulk operations
         */
        function initializeBulkSelection() {
            // Select All checkbox functionality
            const selectAllHeader = document.getElementById('select-all-header');
            const selectAll = document.getElementById('select-all');
            const requestCheckboxes = document.querySelectorAll('.request-checkbox');
            
            // Header select all functionality
            if (selectAllHeader) {
                selectAllHeader.addEventListener('change', function() {
                    const isChecked = this.checked;
                    requestCheckboxes.forEach(checkbox => {
                        checkbox.checked = isChecked;
                        updateRowSelection(checkbox.closest('tr'), isChecked);
                        
                        if (isChecked) {
                            selectedRequests.add(checkbox.value);
                        } else {
                            selectedRequests.delete(checkbox.value);
                        }
                    });
                    updateBulkActionButtons();
                });
            }

            // Sidebar select all functionality  
            if (selectAll) {
                selectAll.addEventListener('change', function() {
                    if (selectAllHeader) {
                        selectAllHeader.checked = this.checked;
                        selectAllHeader.dispatchEvent(new Event('change'));
                    }
                });
            }

            // Individual checkbox functionality
            requestCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const requestId = this.value;
                    const row = this.closest('tr');
                    
                    if (this.checked) {
                        selectedRequests.add(requestId);
                        updateRowSelection(row, true);
                    } else {
                        selectedRequests.delete(requestId);
                        updateRowSelection(row, false);
                    }
                    
                    // Update select all checkboxes
                    const totalCheckboxes = requestCheckboxes.length;
                    const checkedCheckboxes = document.querySelectorAll('.request-checkbox:checked').length;
                    
                    if (selectAllHeader) {
                        selectAllHeader.checked = (checkedCheckboxes === totalCheckboxes);
                        selectAllHeader.indeterminate = (checkedCheckboxes > 0 && checkedCheckboxes < totalCheckboxes);
                    }
                    
                    if (selectAll) {
                        selectAll.checked = (checkedCheckboxes === totalCheckboxes);
                        selectAll.indeterminate = (checkedCheckboxes > 0 && checkedCheckboxes < totalCheckboxes);
                    }
                    
                    updateBulkActionButtons();
                });
            });
        }

        /**
         * Update visual selection state Î³Î¹Î± table row
         */
        function updateRowSelection(row, isSelected) {
            if (isSelected) {
                row.classList.add('bulk-selected');
            } else {
                row.classList.remove('bulk-selected');
            }
        }

        /**
         * Update bulk action buttons based on selection
         */
        function updateBulkActionButtons() {
            const selectedCount = selectedRequests.size;
            const bulkApproveBtn = document.getElementById('bulk-approve-btn');
            const bulkRejectBtn = document.getElementById('bulk-reject-btn');
            const selectedCountSpan = document.getElementById('selected-count');
            
            if (selectedCountSpan) {
                selectedCountSpan.textContent = `${selectedCount} ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½ÎµÏ‚`;
            }
            
            const hasSelection = selectedCount > 0;
            
            if (bulkApproveBtn) {
                bulkApproveBtn.disabled = !hasSelection;
                bulkApproveBtn.style.opacity = hasSelection ? '1' : '0.5';
            }
            
            if (bulkRejectBtn) {
                bulkRejectBtn.disabled = !hasSelection;
                bulkRejectBtn.style.opacity = hasSelection ? '1' : '0.5';
            }
        }

        /**
         * ================================================================
         * MODAL MANAGEMENT FUNCTIONS
         * ================================================================
         */

        /**
         * Show approve modal Î³Î¹Î± single request
         */
        function showApproveModal(requestId) {
            document.getElementById('approve-request-id').value = requestId;
            document.getElementById('manager_comments').value = '';
            showModal('approve-modal');
        }

        /**
         * Show reject modal Î³Î¹Î± single request
         */
        function showRejectModal(requestId) {
            document.getElementById('reject-request-id').value = requestId;
            document.getElementById('rejection_reason').value = '';
            showModal('reject-modal');
        }

        /**
         * Show bulk approve modal
         */
        function showBulkApproveModal() {
            if (selectedRequests.size === 0) {
                alert('âš ï¸ Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ Î¼Î¯Î± Î±Î¯Ï„Î·ÏƒÎ·.');
                return;
            }

            // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± hidden inputs Î³Î¹Î± ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½ÎµÏ‚ Î±Î¹Ï„Î®ÏƒÎµÎ¹Ï‚
            const container = document.getElementById('bulk-approve-requests');
            container.innerHTML = '';
            
            selectedRequests.forEach(requestId => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'selected_requests[]';
                input.value = requestId;
                container.appendChild(input);
            });

            document.getElementById('bulk_comments').value = '';
            showModal('bulk-approve-modal');
        }

        /**
         * Show bulk reject modal
         */
        function showBulkRejectModal() {
            if (selectedRequests.size === 0) {
                alert('âš ï¸ Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ Î¼Î¯Î± Î±Î¯Ï„Î·ÏƒÎ·.');
                return;
            }

            // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± hidden inputs Î³Î¹Î± ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½ÎµÏ‚ Î±Î¹Ï„Î®ÏƒÎµÎ¹Ï‚
            const container = document.getElementById('bulk-reject-requests');
            container.innerHTML = '';
            
            selectedRequests.forEach(requestId => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'selected_requests[]';
                input.value = requestId;
                container.appendChild(input);
            });

            document.getElementById('bulk_rejection_reason').value = '';
            showModal('bulk-reject-modal');
        }

        /**
         * Generic modal show function
         */
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
                
                // Focus ÏƒÏ„Î¿ Ï€ÏÏÏ„Î¿ input field
                const firstInput = modal.querySelector('textarea, input[type="text"]');
                if (firstInput) {
                    setTimeout(() => firstInput.focus(), 100);
                }
            }
        }

        /**
         * Generic modal close function
         */
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto'; // Restore scrolling
            }
        }

        /**
         * Close modal when clicking outside
         */
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                closeModal(e.target.id);
            }
        });

        /**
         * ================================================================
         * FORM VALIDATION FUNCTIONS
         * ================================================================
         */
        function setupFormValidations() {
            // Approve form validation
            const approveForm = document.getElementById('approve-form');
            if (approveForm) {
                approveForm.addEventListener('submit', function(e) {
                    const submitBtn = this.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.innerHTML = '<span class="loading"></span> Î•Î³ÎºÏÎ¯Î½ÎµÏ„Î±Î¹...';
                        submitBtn.disabled = true;
                    }
                });
            }

            // Reject form validation
            const rejectForm = document.getElementById('reject-form');
            if (rejectForm) {
                rejectForm.addEventListener('submit', function(e) {
                    const reason = document.getElementById('rejection_reason').value.trim();
                    if (reason.length < 10) {
                        e.preventDefault();
                        alert('âš ï¸ Î— Î±Î¹Ï„Î¹Î¿Î»Î¿Î³Î¯Î± Î±Ï€ÏŒÏÏÎ¹ÏˆÎ·Ï‚ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ 10 Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎµÏ‚.');
                        return false;
                    }

                    const submitBtn = this.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.innerHTML = '<span class="loading"></span> Î‘Ï€Î¿ÏÏÎ¯Ï€Ï„ÎµÏ„Î±Î¹...';
                        submitBtn.disabled = true;
                    }
                });
            }

            // Bulk approve form validation
            const bulkApproveForm = document.getElementById('bulk-approve-form');
            if (bulkApproveForm) {
                bulkApproveForm.addEventListener('submit', function(e) {
                    if (!confirm(`âš ï¸ Î Î¡ÎŸÎ£ÎŸÎ§Î—!\n\nÎ˜Î± ÎµÎ³ÎºÏÎ¹Î¸Î¿ÏÎ½ ${selectedRequests.size} Î±Î¹Ï„Î®ÏƒÎµÎ¹Ï‚.\nÎ•Î¯ÏƒÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Î¹;`)) {
                        e.preventDefault();
                        return false;
                    }

                    const submitBtn = this.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.innerHTML = '<span class="loading"></span> Î•Î³ÎºÏÎ¯Î½Î¿Î½Ï„Î±Î¹...';
                        submitBtn.disabled = true;
                    }
                });
            }

            // Bulk reject form validation
            const bulkRejectForm = document.getElementById('bulk-reject-form');
            if (bulkRejectForm) {
                bulkRejectForm.addEventListener('submit', function(e) {
                    const reason = document.getElementById('bulk_rejection_reason').value.trim();
                    if (reason.length < 10) {
                        e.preventDefault();
                        alert('âš ï¸ Î— Î±Î¹Ï„Î¹Î¿Î»Î¿Î³Î¯Î± bulk Î±Ï€ÏŒÏÏÎ¹ÏˆÎ·Ï‚ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ 10 Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎµÏ‚.');
                        return false;
                    }

                    if (!confirm(`âš ï¸ Î Î¡ÎŸÎ£ÎŸÎ§Î—!\n\nÎ˜Î± Î±Ï€Î¿ÏÏÎ¹Ï†Î¸Î¿ÏÎ½ ${selectedRequests.size} Î±Î¹Ï„Î®ÏƒÎµÎ¹Ï‚.\nÎ•Î¯ÏƒÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Î¹;`)) {
                        e.preventDefault();
                        return false;
                    }

                    const submitBtn = this.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.innerHTML = '<span class="loading"></span> Î‘Ï€Î¿ÏÏÎ¯Ï€Ï„Î¿Î½Ï„Î±Î¹...';
                        submitBtn.disabled = true;
                    }
                });
            }
        }

        /**
         * ================================================================
         * FILTERING AND SEARCH FUNCTIONALITY
         * ================================================================
         */

        /**
         * Apply filters and reload page
         */
        function applyFilters() {
            // Reset page to 1 when applying filters
            document.querySelector('input[name="page"]').value = 1;
            document.getElementById('filters-form').submit();
        }

        /**
         * Clear all filters
         */
        function clearAllFilters() {
            const form = document.getElementById('filters-form');
            const selects = form.querySelectorAll('select');
            const inputs = form.querySelectorAll('input[type="date"]');
            
            selects.forEach(select => {
                if (select.name !== 'sort' && select.name !== 'order') {
                    select.value = 'ALL';
                } else if (select.name === 'sort') {
                    select.value = 'submitted_at';
                } else if (select.name === 'order') {
                    select.value = 'ASC';
                }
            });

            inputs.forEach(input => {
                input.value = '';
            });

            applyFilters();
        }

        /**
         * ================================================================
         * REQUEST DETAILS FUNCTIONALITY
         * ================================================================
         */

        /**
         * View detailed request information
         */
        function viewRequestDetails(requestId) {
            // Create popup window Î¼Îµ request details
            const popup = window.open(
                `request-details.php?id=${requestId}&mode=popup`, 
                'RequestDetails',
                'width=800,height=700,scrollbars=yes,resizable=yes,toolbar=no,menubar=no'
            );
            
            if (!popup) {
                // Fallback: Navigate to details page in same window
                window.open(`request-details.php?id=${requestId}`, '_blank');
            }
        }

        /**
         * ================================================================
         * AUTO-REFRESH FUNCTIONALITY
         * ================================================================
         */
        function initializeAutoRefresh() {
            // Auto-refresh ÎºÎ¬Î¸Îµ 60 Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î± Î³Î¹Î± real-time updates
            autoRefreshInterval = setInterval(checkForUpdates, 60000);
            
            // Check for visibility change to pause/resume auto-refresh
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    if (autoRefreshInterval) {
                        clearInterval(autoRefreshInterval);
                        autoRefreshInterval = null;
                    }
                } else {
                    if (!autoRefreshInterval) {
                        autoRefreshInterval = setInterval(checkForUpdates, 60000);
                    }
                }
            });
        }

        /**
         * Check for new updates via AJAX
         */
        function checkForUpdates() {
            fetch('ajax/check-pending-updates.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    last_check: lastUpdateCheck,
                    current_filters: getCurrentFilters()
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.has_updates) {
                    showUpdateNotification(data.update_count);
                }
                lastUpdateCheck = new Date().toISOString();
            })
            .catch(error => {
                console.log('Update check failed:', error);
            });
        }

        /**
         * Get current filter state
         */
        function getCurrentFilters() {
            const form = document.getElementById('filters-form');
            const formData = new FormData(form);
            const filters = {};
            
            for (let [key, value] of formData.entries()) {
                filters[key] = value;
            }
            
            return filters;
        }

        /**
         * Show notification Î³Î¹Î± updates
         */
        function showUpdateNotification(updateCount) {
            const notification = document.createElement('div');
            notification.className = 'alert alert-info';
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '9999';
            notification.style.maxWidth = '350px';
            notification.innerHTML = `
                <strong>ğŸ”„ ÎÎ­ÎµÏ‚ ÎµÎ½Î·Î¼ÎµÏÏÏƒÎµÎ¹Ï‚!</strong><br>
                ${updateCount} Î½Î­ÎµÏ‚ Î±Î»Î»Î±Î³Î­Ï‚ ÏƒÏ„Î¹Ï‚ ÎµÎºÎºÏÎµÎ¼ÎµÎ¯Ï‚ Î±Î¹Ï„Î®ÏƒÎµÎ¹Ï‚.
                <br>
                <button onclick="location.reload()" class="btn btn-sm btn-primary" style="margin-top: 8px;">
                    ğŸ”„ Î‘Î½Î±Î½Î­Ï‰ÏƒÎ·
                </button>
                <button onclick="this.parentElement.remove()" class="btn btn-sm btn-secondary" style="margin-top: 8px; margin-left: 5px;">
                    âœ• ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿
                </button>
            `;

            document.body.appendChild(notification);

            // Auto-remove Î¼ÎµÏ„Î¬ Î±Ï€ÏŒ 15 Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î±
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 15000);
        }

        /**
         * ================================================================
         * KEYBOARD SHORTCUTS
         * ================================================================
         */
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl+A: Select/Deselect All
                if (e.ctrlKey && e.key === 'a' && !e.target.matches('input, textarea')) {
                    e.preventDefault();
                    const selectAllHeader = document.getElementById('select-all-header');
                    if (selectAllHeader) {
                        selectAllHeader.checked = !selectAllHeader.checked;
                        selectAllHeader.dispatchEvent(new Event('change'));
                    }
                }

                // Ctrl+E: Bulk Approve (if items selected)
                if (e.ctrlKey && e.key === 'e') {
                    e.preventDefault();
                    if (selectedRequests.size > 0) {
                        showBulkApproveModal();
                    }
                }

                // Ctrl+R: Bulk Reject (if items selected)
                if (e.ctrlKey && e.key === 'r') {
                    e.preventDefault();
                    if (selectedRequests.size > 0) {
                        showBulkRejectModal();
                    }
                }

                // F5 or Ctrl+R: Refresh page
                if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
                    // Let default behavior handle this
                }

                // Escape: Close modals or clear selections
                if (e.key === 'Escape') {
                    // Close any open modals
                    const openModals = document.querySelectorAll('.modal[style*="block"]');
                    openModals.forEach(modal => {
                        closeModal(modal.id);
                    });

                    // If no modals, clear selections
                    if (openModals.length === 0 && selectedRequests.size > 0) {
                        const selectAllHeader = document.getElementById('select-all-header');
                        if (selectAllHeader) {
                            selectAllHeader.checked = false;
                            selectAllHeader.dispatchEvent(new Event('change'));
                        }
                    }
                }

                // Enter: Submit focused form
                if (e.key === 'Enter' && e.target.matches('textarea')) {
                    // Allow Enter in textareas
                    return;
                }
            });
        }

        /**
         * ================================================================
         * EXPORT FUNCTIONALITY
         * ================================================================
         */

        /**
         * Export requests to PDF or Excel
         */
        function exportRequests(format) {
            const currentFilters = getCurrentFilters();
            currentFilters.export = format;
            currentFilters.selected_only = selectedRequests.size > 0 ? 'true' : 'false';
            
            if (selectedRequests.size > 0) {
                currentFilters.selected_requests = Array.from(selectedRequests);
            }
            
            // Create temporary form Î³Î¹Î± export
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = 'export-pending-requests.php';
            form.target = '_blank';
            form.style.display = 'none';

            // Add CSRF token
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = '<?php echo $csrf_token; ?>';
            form.appendChild(csrfInput);

            // Add filters as hidden inputs
            for (const [key, value] of Object.entries(currentFilters)) {
                if (Array.isArray(value)) {
                    value.forEach(v => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = key + '[]';
                        input.value = v;
                        form.appendChild(input);
                    });
                } else {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = value;
                    form.appendChild(input);
                }
            }

            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);

            // Show feedback message
            showTemporaryMessage(
                `ğŸ“„ Export ${format.toUpperCase()} Î¾ÎµÎºÎ¯Î½Î·ÏƒÎµ...`,
                'info',
                3000
            );
        }

        /**
         * ================================================================
         * UTILITY FUNCTIONS
         * ================================================================
         */

        /**
         * Initialize tooltips
         */
        function initializeTooltips() {
            const tooltipElements = document.querySelectorAll('[data-tooltip]');
            tooltipElements.forEach(element => {
                // Enhanced tooltip functionality could be added here
                element.addEventListener('mouseenter', function() {
                    // Custom tooltip implementation
                });
            });
        }

        /**
         * Show temporary message
         */
        function showTemporaryMessage(message, type = 'info', duration = 5000) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.style.position = 'fixed';
            alert.style.top = '20px';
            alert.style.left = '50%';
            alert.style.transform = 'translateX(-50%)';
            alert.style.zIndex = '9999';
            alert.style.minWidth = '300px';
            alert.style.textAlign = 'center';
            alert.innerHTML = message;

            document.body.appendChild(alert);

            setTimeout(() => {
                if (alert.parentElement) {
                    alert.style.opacity = '0';
                    alert.style.transition = 'opacity 0.5s ease';
                    setTimeout(() => alert.remove(), 500);
                }
            }, duration);
        }

        /**
         * Format number with thousands separator
         */
        function formatNumber(num) {
            return new Intl.NumberFormat('el-GR').format(num);
        }

        /**
         * Calculate business days between dates
         */
        function calculateBusinessDays(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            let businessDays = 0;
            
            const currentDate = new Date(start);
            while (currentDate <= end) {
                const dayOfWeek = currentDate.getDay();
                if (dayOfWeek !== 0 && dayOfWeek !== 6) { // Skip weekends
                    businessDays++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            return businessDays;
        }

        /**
         * ================================================================
         * DEBUG AND DEVELOPMENT FUNCTIONS
         * ================================================================
         */

        /**
         * Console logging for debugging
         */
        function logDebugInfo() {
            console.group('ğŸ” Pending Requests Debug Info');
            console.log('Selected Requests:', Array.from(selectedRequests));
            console.log('Current Filters:', getCurrentFilters());
            console.log('Total Requests:', document.querySelectorAll('.request-row').length);
            console.log('Auto-refresh Active:', !!autoRefreshInterval);
            console.log('Last Update Check:', lastUpdateCheck);
            console.groupEnd();
        }

        // Expose debug function to console
        window.debugPendingRequests = logDebugInfo;

        /**
         * Performance monitoring
         */
        window.addEventListener('load', function() {
            const loadTime = performance.now();
            console.log(`âš¡ Page loaded in ${Math.round(loadTime)}ms`);
            
            // Log performance metrics
            if (performance.getEntriesByType) {
                const navigationTiming = performance.getEntriesByType('navigation')[0];
                if (navigationTiming) {
                    console.log(`ğŸ“Š Navigation Timing:
                        - DNS Lookup: ${Math.round(navigationTiming.domainLookupEnd - navigationTiming.domainLookupStart)}ms
                        - Server Response: ${Math.round(navigationTiming.responseEnd - navigationTiming.requestStart)}ms
                        - DOM Content Loaded: ${Math.round(navigationTiming.domContentLoadedEventEnd - navigationTiming.navigationStart)}ms
                    `);
                }
            }
        });

        // Development shortcuts ÏƒÏ„Î¿ console
        console.log(`
ğŸ¯ KEYBOARD SHORTCUTS:
- Ctrl+A: Select/Deselect All Requests
- Ctrl+E: Bulk Approve (if selected)
- Ctrl+R: Bulk Reject (if selected)  
- Escape: Close modals or clear selections
- F5: Refresh page

ğŸ”§ DEBUG COMMANDS:
- window.debugPendingRequests(): Show debug info

ğŸ“Š CURRENT PAGE STATS:
- Total Pending: <?php echo $stats['total_pending'] ?? 0; ?>
- Urgent Requests: <?php echo $stats['urgent'] ?? 0; ?>
- Current Page: <?php echo $page; ?>/<?php echo $total_pages; ?>
- User Role: <?php echo $is_admin ? 'Administrator' : 'Manager'; ?>
        `);

        /**
         * ================================================================
         * ADDITIONAL UTILITY FUNCTIONS
         * ================================================================
         */

        /**
         * Scroll to top smoothly
         */
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        /**
         * Copy request details to clipboard
         */
        function copyRequestDetails(requestId) {
            const row = document.querySelector(`[data-request-id="${requestId}"]`);
            if (row) {
                const details = extractRequestDetails(row);
                navigator.clipboard.writeText(details).then(() => {
                    showTemporaryMessage('ğŸ“‹ Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î± Î±Î½Ï„Î¹Î³ÏÎ¬Ï†Î·ÎºÎ±Î½!', 'success', 2000);
                });
            }
        }

        /**
         * Extract request details from table row
         */
        function extractRequestDetails(row) {
            const cells = row.querySelectorAll('td');
            // Extract text content from relevant cells
            const employee = cells[1].textContent.trim();
            const leaveType = cells[2].textContent.trim();
            const leaveDate = cells[3].textContent.trim();
            const duration = cells[4].textContent.trim();
            const priority = cells[5].textContent.trim();
            
            return `Î¥Ï€Î¬Î»Î»Î·Î»Î¿Ï‚: ${employee}
Î¤ÏÏ€Î¿Ï‚ Î†Î´ÎµÎ¹Î±Ï‚: ${leaveType}
Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±: ${leaveDate}
Î”Î¹Î¬ÏÎºÎµÎ¹Î±: ${duration}
Î ÏÎ¿Ï„ÎµÏÎ±Î¹ÏŒÏ„Î·Ï„Î±: ${priority}`;
        }

        /**
         * Print current page
         */
        function printPage() {
            window.print();
        }

        /**
         * Toggle compact view
         */
        function toggleCompactView() {
            const table = document.querySelector('.requests-table');
            table.classList.toggle('compact-view');
            
            // Save preference to localStorage
            const isCompact = table.classList.contains('compact-view');
            localStorage.setItem('pendingRequestsCompactView', isCompact);
        }

        /**
         * Load saved preferences
         */
        function loadUserPreferences() {
            // Restore compact view preference
            const isCompact = localStorage.getItem('pendingRequestsCompactView') === 'true';
            if (isCompact) {
                document.querySelector('.requests-table').classList.add('compact-view');
            }
        }

        // Load preferences on page load
        document.addEventListener('DOMContentLoaded', loadUserPreferences);

        /**
         * ================================================================
         * ERROR HANDLING AND RECOVERY
         * ================================================================
         */

        /**
         * Global error handler
         */
        window.addEventListener('error', function(e) {
            console.error('JavaScript Error:', e.error);
            
            // Show user-friendly error message
            showTemporaryMessage(
                'âš ï¸ Î ÏÎ¿Î­ÎºÏ…ÏˆÎµ ÏƒÏ†Î¬Î»Î¼Î±. Î Î±ÏÎ±ÎºÎ±Î»Ï Î±Î½Î±Î½ÎµÏÏƒÏ„Îµ Ï„Î· ÏƒÎµÎ»Î¯Î´Î±.',
                'danger',
                5000
            );
        });

        /**
         * Handle network errors
         */
        window.addEventListener('online', function() {
            showTemporaryMessage('ğŸŒ Î— ÏƒÏÎ½Î´ÎµÏƒÎ· Î±Ï€Î¿ÎºÎ±Ï„Î±ÏƒÏ„Î¬Î¸Î·ÎºÎµ!', 'success', 3000);
            // Resume auto-refresh
            if (!autoRefreshInterval) {
                initializeAutoRefresh();
            }
        });

        window.addEventListener('offline', function() {
            showTemporaryMessage('ğŸ“¡ Î§Ï‰ÏÎ¯Ï‚ ÏƒÏÎ½Î´ÎµÏƒÎ· ÏƒÏ„Î¿ Î´Î¹Î±Î´Î¯ÎºÏ„Ï…Î¿', 'warning', 5000);
            // Pause auto-refresh
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        });

        /**
         * ================================================================
         * ACCESSIBILITY ENHANCEMENTS
         * ================================================================
         */

        /**
         * Keyboard navigation for table
         */
        function setupKeyboardNavigation() {
            const rows = document.querySelectorAll('.request-row');
            let currentRowIndex = -1;

            document.addEventListener('keydown', function(e) {
                if (e.target.matches('input, textarea, select')) return;

                switch(e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        currentRowIndex = Math.min(currentRowIndex + 1, rows.length - 1);
                        highlightRow(currentRowIndex);
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        currentRowIndex = Math.max(currentRowIndex - 1, 0);
                        highlightRow(currentRowIndex);
                        break;
                    case ' ': // Space to toggle selection
                        e.preventDefault();
                        if (currentRowIndex >= 0) {
                            const checkbox = rows[currentRowIndex].querySelector('.request-checkbox');
                            if (checkbox) {
                                checkbox.checked = !checkbox.checked;
                                checkbox.dispatchEvent(new Event('change'));
                            }
                        }
                        break;
                }
            });
        }

        /**
         * Highlight current row
         */
        function highlightRow(index) {
            // Remove previous highlights
            document.querySelectorAll('.keyboard-highlight').forEach(row => {
                row.classList.remove('keyboard-highlight');
            });

            const rows = document.querySelectorAll('.request-row');
            if (rows[index]) {
                rows[index].classList.add('keyboard-highlight');
                rows[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Initialize keyboard navigation
        document.addEventListener('DOMContentLoaded', setupKeyboardNavigation);

        /**
         * ================================================================
         * FINAL INITIALIZATION
         * ================================================================
         */

        // Ensure all functionality is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Double-check all critical elements are present
            const criticalElements = [
                'filters-form',
                'bulk-approve-btn', 
                'bulk-reject-btn',
                'selected-count'
            ];

            criticalElements.forEach(id => {
                if (!document.getElementById(id)) {
                    console.warn(`âš ï¸ Critical element missing: ${id}`);
                }
            });

            // Mark page as fully loaded
            document.body.setAttribute('data-page-loaded', 'true');
            
            // Final console log
            console.log('âœ… Pending Requests Management System fully initialized');
        });
    </script>

    <!-- Add some additional CSS for enhanced functionality -->
    <style>
        /* Compact view styles */
        .requests-table.compact-view th,
        .requests-table.compact-view td {
            padding: 8px 6px;
            font-size: 0.85rem;
        }

        /* Keyboard navigation highlight */
        .keyboard-highlight {
            outline: 2px solid #667eea;
            outline-offset: -2px;
            background-color: rgba(102, 126, 234, 0.1) !important;
        }

        /* Enhanced loading state */
        .loading-state {
            opacity: 0.6;
            pointer-events: none;
            position: relative;
        }

        .loading-state::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Responsive table improvements */
        @media (max-width: 768px) {
            .requests-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .modal-content {
                width: 95%;
                margin: 20px auto;
                max-height: 90vh;
            }
        }

        /* Print styles */
        @media print {
            .controls-section,
            .pagination-container,
            .action-buttons,
            .back-btn {
                display: none !important;
            }
            
            .header {
                background: white !important;
                color: black !important;
            }
        }
    </style>
</body>
</html>
